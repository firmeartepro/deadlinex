<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeadlineX - Gerenciador de Prazos</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⏰</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .gradient-bg { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 50%, #ec4899 100%); }
        .gradient-premium { background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%); }
        .gradient-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .gradient-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 12px 35px rgba(79, 70, 229, 0.15); }
        .priority-high { border-left: 4px solid #ef4444; background: linear-gradient(90deg, #fef2f2 0%, #ffffff 100%); }
        .priority-normal { border-left: 4px solid #f59e0b; background: linear-gradient(90deg, #fffbeb 0%, #ffffff 100%); }
        .priority-low { border-left: 4px solid #10b981; background: linear-gradient(90deg, #f0fdf4 0%, #ffffff 100%); }
        .premium-banner { background: linear-gradient(45deg, #fbbf24, #f59e0b, #d97706); }
        .modal-backdrop { backdrop-filter: blur(8px); }
        .btn-primary { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .btn-success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .btn-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .glass-effect { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); }
        .text-gradient { background: linear-gradient(135deg, #4f46e5, #7c3aed, #ec4899); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="glass-effect rounded-3xl shadow-2xl p-8 w-full max-w-lg mx-4">
            <div class="text-center mb-8">
                <div class="text-7xl mb-4 animate-pulse">⏰</div>
                <h1 class="text-4xl font-bold text-gradient mb-3">DeadlineX</h1>
                <p class="text-gray-700 text-lg">Gerencie seus prazos com inteligência</p>
            </div>
            
            <!-- Login/Register Toggle -->
            <div class="flex bg-gray-100 rounded-xl p-1 mb-6">
                <button id="loginTab" onclick="showLoginForm()" class="flex-1 py-2 px-4 rounded-lg btn-primary text-white font-medium transition-all">
                    Entrar
                </button>
                <button id="registerTab" onclick="showRegisterForm()" class="flex-1 py-2 px-4 rounded-lg text-gray-600 font-medium transition-all">
                    Cadastrar
                </button>
            </div>
            
            <!-- Login Form -->
            <div id="loginForm">
                <button onclick="loginWithGoogle()" class="w-full btn-danger text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center gap-3 transition-all hover:shadow-lg mb-4">
                    <i class="fab fa-google text-xl"></i>
                    Entrar com Google
                </button>
                <p class="text-center text-sm text-gray-600">Acesso rápido e seguro</p>
            </div>
            
            <!-- Register Form -->
            <div id="registerForm" class="hidden">
                <div class="space-y-4 mb-6">
                    <h3 class="text-xl font-bold text-center text-gray-800">Escolha seu plano</h3>
                    
                    <!-- Free Plan -->
                    <div id="freePlan" onclick="selectPlan('free')" class="border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all hover:border-indigo-500 hover:shadow-md">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-lg">Plano Grátis</h4>
                            <div class="text-2xl font-bold text-green-600">R$ 0</div>
                        </div>
                        <ul class="text-sm text-gray-600 space-y-1">
                            <li><i class="fas fa-check text-green-500 mr-2"></i>4 Categorias básicas</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Notificações locais</li>
                            <li><i class="fas fa-check text-green-500 mr-2"></i>Funcionalidades essenciais</li>
                        </ul>
                    </div>
                    
                    <!-- Premium Plan -->
                    <div id="premiumPlan" onclick="selectPlan('premium')" class="border-2 border-amber-400 rounded-xl p-4 cursor-pointer transition-all hover:border-amber-500 hover:shadow-md gradient-premium text-white">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-bold text-lg flex items-center gap-2">
                                <i class="fas fa-crown"></i>Plano Premium
                            </h4>
                            <div class="text-2xl font-bold">R$ 4,90/mês</div>
                        </div>
                        <ul class="text-sm space-y-1">
                            <li><i class="fas fa-check mr-2"></i>15 Categorias completas</li>
                            <li><i class="fas fa-check mr-2"></i>Lista de compras + gráficos</li>
                            <li><i class="fas fa-check mr-2"></i>Notificações WhatsApp</li>
                            <li><i class="fas fa-check mr-2"></i>Suporte prioritário</li>
                        </ul>
                    </div>
                </div>
                
                <button onclick="registerWithGoogle()" class="w-full btn-success text-white font-semibold py-4 px-6 rounded-xl flex items-center justify-center gap-3 transition-all hover:shadow-lg">
                    <i class="fab fa-google text-xl"></i>
                    Cadastrar com Google
                </button>
                <p class="text-center text-sm text-gray-600 mt-2">Plano selecionado: <span id="selectedPlan" class="font-semibold">Grátis</span></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center gap-3">
                        <div class="text-3xl">⏰</div>
                        <h1 class="text-xl font-bold text-gray-800">DeadlineX</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="shareApp()" class="text-blue-600 hover:text-blue-800 font-medium">
                            <i class="fas fa-share-alt mr-2"></i>Compartilhar
                        </button>
                        <button onclick="showPolicies()" class="text-gray-600 hover:text-gray-800 font-medium">
                            <i class="fas fa-shield-alt mr-2"></i>Políticas
                        </button>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Buttons -->
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                <button onclick="showNewDeadlineModal()" class="btn-success text-white font-semibold py-6 px-6 rounded-xl flex items-center justify-center gap-3 card-hover shadow-lg">
                    <i class="fas fa-plus text-xl"></i>Novos Prazos
                </button>
                <button onclick="showNotifications()" class="btn-primary text-white font-semibold py-6 px-6 rounded-xl flex items-center justify-center gap-3 card-hover shadow-lg">
                    <i class="fas fa-bell text-xl"></i>Notificações
                </button>
                <button onclick="installApp()" class="btn-warning text-white font-semibold py-6 px-6 rounded-xl flex items-center justify-center gap-3 card-hover shadow-lg">
                    <i class="fas fa-download text-xl"></i>Instalar App
                </button>
            </div>

            <!-- Stats Menu -->
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
                    <div class="text-sm text-gray-600">Total</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <div class="text-2xl font-bold text-red-600 flex items-center justify-center gap-2">
                        <i class="fas fa-exclamation-triangle text-lg"></i>
                        <span id="urgentCount">0</span>
                    </div>
                    <div class="text-sm text-gray-600">Urgentes</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <div class="text-2xl font-bold text-orange-600" id="weekCount">0</div>
                    <div class="text-sm text-gray-600">Esta Semana</div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                    <div class="text-2xl font-bold text-green-600" id="completedCount">0</div>
                    <div class="text-sm text-gray-600">Concluídos</div>
                </div>
            </div>

            <!-- Search and Filter -->
            <div class="bg-white p-6 rounded-lg shadow-sm mb-6">
                <div class="flex flex-col lg:flex-row gap-4">
                    <div class="flex-1">
                        <input type="text" id="searchInput" placeholder="Buscar prazo específico..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex gap-2">
                        <select id="categoryFilter" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Todas as categorias</option>
                            <option value="pessoal">Pessoal</option>
                            <option value="trabalho">Trabalho</option>
                            <option value="saude">Saúde</option>
                            <option value="outros">Outros</option>
                            <option value="aniversarios" class="premium-option text-gray-400">🔒 Aniversários (Premium)</option>
                            <option value="educacao" class="premium-option text-gray-400">🔒 Educação (Premium)</option>
                            <option value="eventos" class="premium-option text-gray-400">🔒 Eventos (Premium)</option>
                            <option value="financeiro" class="premium-option text-gray-400">🔒 Financeiro (Premium)</option>
                            <option value="impostos" class="premium-option text-gray-400">🔒 Impostos (Premium)</option>
                            <option value="juridico" class="premium-option text-gray-400">🔒 Jurídico (Premium)</option>
                            <option value="manutencao" class="premium-option text-gray-400">🔒 Manutenção (Premium)</option>
                            <option value="reunioes" class="premium-option text-gray-400">🔒 Reuniões (Premium)</option>
                            <option value="seguros" class="premium-option text-gray-400">🔒 Seguros (Premium)</option>
                            <option value="veiculos" class="premium-option text-gray-400">🔒 Veículos (Premium)</option>
                            <option value="viagens" class="premium-option text-gray-400">🔒 Viagens (Premium)</option>
                        </select>
                        <button onclick="clearFilters()" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Deadlines List -->
            <div id="deadlinesList" class="space-y-4 mb-8">
                <!-- Deadlines will be loaded here -->
            </div>

            <!-- Shopping List Section (Premium) -->
            <div id="shoppingSection" class="hidden bg-white p-6 rounded-lg shadow-sm mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-shopping-cart mr-2"></i>Lista de Compras
                    </h2>
                    <button onclick="showNewItemModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus mr-2"></i>Novo Item
                    </button>
                </div>
                <div id="shoppingList" class="space-y-2">
                    <!-- Shopping items will be loaded here -->
                </div>
                <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                    <div class="text-lg font-semibold">Total do mês: R$ <span id="monthlyTotal">0,00</span></div>
                </div>
            </div>
        </div>

        <!-- Premium Banner Footer -->
        <footer class="premium-banner p-6 text-center">
            <div class="max-w-4xl mx-auto">
                <h3 class="text-xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-crown mr-2"></i>Upgrade para Premium
                </h3>
                <p class="text-gray-700 mb-4">Desbloqueie todas as categorias, lista de compras e notificações WhatsApp!</p>
                <button onclick="showPremiumModal()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-8 rounded-lg shadow-lg">
                    Ver Planos Premium
                </button>
            </div>
        </footer>
    </div>

    <!-- New Deadline Modal -->
    <div id="newDeadlineModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">Novo Prazo</h2>
                <button onclick="closeModal('newDeadlineModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form id="deadlineForm" class="space-y-4">
                <input type="text" id="deadlineTitle" placeholder="Título do prazo" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <textarea id="deadlineDescription" placeholder="Descrição (opcional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 h-20"></textarea>
                <input type="datetime-local" id="deadlineDate" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <select id="deadlineCategory" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">Selecione uma categoria</option>
                    <option value="pessoal">Pessoal</option>
                    <option value="trabalho">Trabalho</option>
                    <option value="saude">Saúde</option>
                    <option value="outros">Outros</option>
                </select>
                <select id="deadlinePriority" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="normal">Prioridade Normal</option>
                    <option value="high">Alta Prioridade</option>
                    <option value="low">Baixa Prioridade</option>
                </select>
                <div class="flex items-center gap-2">
                    <input type="checkbox" id="deadlineNotification" checked class="rounded">
                    <label for="deadlineNotification">Ativar notificações</label>
                </div>
                <button type="submit" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-lg">
                    Salvar Prazo
                </button>
            </form>
        </div>
    </div>

    <!-- Premium Modal -->
    <div id="premiumModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-600">
                    <i class="fas fa-crown mr-2"></i>DeadlineX Premium
                </h2>
                <button onclick="closeModal('premiumModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div class="border rounded-lg p-4">
                    <h3 class="font-bold text-lg mb-3">Plano Grátis</h3>
                    <ul class="space-y-2 text-sm">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>4 Categorias básicas</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Notificações locais</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Funcionalidades básicas</li>
                    </ul>
                </div>
                
                <div class="border-2 border-purple-500 rounded-lg p-4 bg-purple-50">
                    <h3 class="font-bold text-lg mb-3 text-purple-600">Plano Premium</h3>
                    <div class="text-2xl font-bold text-purple-600 mb-3">R$ 4,90/mês</div>
                    <ul class="space-y-2 text-sm">
                        <li><i class="fas fa-check text-green-500 mr-2"></i>15 Categorias completas</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Lista de compras inteligente</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Gráficos de gastos mensais</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Notificações WhatsApp</li>
                        <li><i class="fas fa-check text-green-500 mr-2"></i>Suporte prioritário</li>
                    </ul>
                </div>
            </div>
            
            <button onclick="purchasePremium()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-4 rounded-lg text-lg">
                <i class="fas fa-credit-card mr-2"></i>Assinar Premium - R$ 4,90/mês
            </button>
        </div>
    </div>

    <!-- Policies Modal -->
    <div id="policiesModal" class="hidden fixed inset-0 bg-black bg-opacity-50 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">Políticas e Termos</h2>
                <button onclick="closeModal('policiesModal')" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">Política de Privacidade (LGPD)</h3>
                    <p class="text-gray-600 text-sm">Seus dados são protegidos conforme a Lei Geral de Proteção de Dados. Coletamos apenas informações necessárias para o funcionamento do aplicativo.</p>
                </div>
                
                <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">Termos de Uso</h3>
                    <p class="text-gray-600 text-sm">Ao usar o DeadlineX, você concorda com nossos termos de serviço e se compromete a usar a plataforma de forma responsável.</p>
                </div>
                
                <div class="border-b pb-4">
                    <h3 class="font-bold text-lg mb-2">Política de Cookies</h3>
                    <p class="text-gray-600 text-sm">Utilizamos cookies essenciais para melhorar sua experiência e manter suas preferências de uso.</p>
                </div>
                
                <div class="bg-red-50 p-4 rounded-lg">
                    <h3 class="font-bold text-lg mb-2 text-red-600">Exclusão de Conta</h3>
                    <p class="text-gray-600 text-sm mb-3">Você pode solicitar a exclusão completa de sua conta e dados a qualquer momento.</p>
                    <button onclick="deleteAccount()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-trash mr-2"></i>Excluir Minha Conta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://vastjlzaxafpoagptklu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhc3RqbHpheGFmcG9hZ3B0a2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjUzMDEsImV4cCI6MjA3MTg0MTMwMX0.4EnnkdyVDEo1qSp1C2-QgVlklUkL2W3ulqOmXX_DiVY';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Mercado Pago Configuration
        const MERCADO_PAGO_PUBLIC_KEY = 'YOUR_MERCADO_PAGO_PUBLIC_KEY';
        
        // WhatsApp API Configuration (Evolution API - Plano grátis generoso)
        const WHATSAPP_API_URL = 'https://evolution-api.com/api';
        const WHATSAPP_API_KEY = 'YOUR_EVOLUTION_API_KEY';

        let currentUser = null;
        let isPremium = false;
        let deadlines = [];
        let selectedRegistrationPlan = 'free';

        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            setupEventListeners();
            requestNotificationPermission();
            
            // Listen for auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                console.log('Auth state changed:', event, session);
                if (event === 'SIGNED_IN' && session) {
                    currentUser = session.user;
                    showMainApp();
                    loadUserData();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    isPremium = false;
                    deadlines = [];
                    showLoginScreen();
                }
            });
        });

        // Authentication
        async function loginWithGoogle() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://www.deadlinex.com.br'
                    }
                });
                if (error) throw error;
            } catch (error) {
                alert('Erro no login: ' + error.message);
            }
        }

        async function registerWithGoogle() {
            try {
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: 'https://www.deadlinex.com.br?plan=' + selectedRegistrationPlan
                    }
                });
                if (error) throw error;
            } catch (error) {
                alert('Erro no cadastro: ' + error.message);
            }
        }

        // Login/Register Form Functions
        function showLoginForm() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginTab').className = 'flex-1 py-2 px-4 rounded-lg btn-primary text-white font-medium transition-all';
            document.getElementById('registerTab').className = 'flex-1 py-2 px-4 rounded-lg text-gray-600 font-medium transition-all';
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('loginTab').className = 'flex-1 py-2 px-4 rounded-lg text-gray-600 font-medium transition-all';
            document.getElementById('registerTab').className = 'flex-1 py-2 px-4 rounded-lg btn-primary text-white font-medium transition-all';
        }

        function selectPlan(plan) {
            selectedRegistrationPlan = plan;
            document.getElementById('selectedPlan').textContent = plan === 'free' ? 'Grátis' : 'Premium';
            
            // Update visual selection
            document.getElementById('freePlan').className = plan === 'free' 
                ? 'border-2 border-indigo-500 rounded-xl p-4 cursor-pointer transition-all shadow-md bg-indigo-50'
                : 'border-2 border-gray-200 rounded-xl p-4 cursor-pointer transition-all hover:border-indigo-500 hover:shadow-md';
            
            document.getElementById('premiumPlan').className = plan === 'premium'
                ? 'border-2 border-amber-500 rounded-xl p-4 cursor-pointer transition-all shadow-lg gradient-premium text-white ring-2 ring-amber-300'
                : 'border-2 border-amber-400 rounded-xl p-4 cursor-pointer transition-all hover:border-amber-500 hover:shadow-md gradient-premium text-white';
        }

        async function checkAuth() {
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                if (error) {
                    console.error('Erro na autenticação:', error);
                    showLoginScreen();
                    return;
                }
                
                if (session && session.user) {
                    currentUser = session.user;
                    console.log('Usuário logado:', currentUser.email);
                    showMainApp();
                    await loadUserData();
                } else {
                    console.log('Nenhuma sessão ativa');
                    showLoginScreen();
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                showLoginScreen();
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            showLoginScreen();
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
        }

        // Load User Data
        async function loadUserData() {
            await checkPremiumStatus();
            await loadDeadlines();
            updateStats();
            setupPremiumFeatures();
        }

        async function checkPremiumStatus() {
            try {
                const { data, error } = await supabase
                    .from('user_settings')
                    .select('settings')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (data && data.settings.premium) {
                    isPremium = true;
                    document.getElementById('shoppingSection').classList.remove('hidden');
                }
            } catch (error) {
                console.log('User settings not found, creating default...');
            }
        }

        // Deadlines Management
        async function loadDeadlines() {
            try {
                const { data, error } = await supabase
                    .from('deadlines')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: true });
                
                if (error) throw error;
                deadlines = data || [];
                renderDeadlines();
                scheduleNotifications();
            } catch (error) {
                console.error('Error loading deadlines:', error);
            }
        }

        function renderDeadlines() {
            const container = document.getElementById('deadlinesList');
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            
            let filteredDeadlines = deadlines.filter(deadline => {
                const matchesSearch = deadline.title.toLowerCase().includes(searchTerm) || 
                                    (deadline.description && deadline.description.toLowerCase().includes(searchTerm));
                const matchesCategory = !categoryFilter || deadline.category === categoryFilter;
                return matchesSearch && matchesCategory;
            });

            if (filteredDeadlines.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <i class="fas fa-calendar-times text-4xl mb-4"></i>
                        <p>Nenhum prazo encontrado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredDeadlines.map(deadline => {
                const date = new Date(deadline.date);
                const now = new Date();
                const isOverdue = date < now && !deadline.completed;
                const isUrgent = (date - now) <= 24 * 60 * 60 * 1000; // 24 hours
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-sm card-hover priority-${deadline.priority} ${deadline.completed ? 'opacity-60' : ''}">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <h3 class="font-semibold text-lg ${deadline.completed ? 'line-through' : ''}">${deadline.title}</h3>
                                    ${isOverdue ? '<span class="text-red-500 text-sm font-bold">ATRASADO</span>' : ''}
                                    ${isUrgent && !isOverdue ? '<span class="text-orange-500 text-sm font-bold">URGENTE</span>' : ''}
                                </div>
                                <p class="text-gray-600 text-sm mb-2">${deadline.description || ''}</p>
                                <div class="flex items-center gap-4 text-sm text-gray-500">
                                    <span><i class="fas fa-tag mr-1"></i>${getCategoryName(deadline.category)}</span>
                                    <span><i class="fas fa-clock mr-1"></i>${formatDate(deadline.date)}</span>
                                    <span class="priority-${deadline.priority}"><i class="fas fa-flag mr-1"></i>${getPriorityName(deadline.priority)}</span>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 ml-4">
                                <button onclick="editDeadline(${deadline.id})" class="text-blue-500 hover:text-blue-700 p-2">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="toggleComplete(${deadline.id})" class="text-green-500 hover:text-green-700 p-2">
                                    <i class="fas fa-${deadline.completed ? 'undo' : 'check'}"></i>
                                </button>
                                <button onclick="deleteDeadline(${deadline.id})" class="text-red-500 hover:text-red-700 p-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Deadline Form Handling
        document.getElementById('deadlineForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const title = document.getElementById('deadlineTitle').value;
            const description = document.getElementById('deadlineDescription').value;
            const date = document.getElementById('deadlineDate').value;
            const category = document.getElementById('deadlineCategory').value;
            const priority = document.getElementById('deadlinePriority').value;
            const notification = document.getElementById('deadlineNotification').checked;

            // Check if category is premium and user is not premium
            const premiumCategories = ['aniversarios', 'educacao', 'eventos', 'financeiro', 'impostos', 'juridico', 'manutencao', 'reunioes', 'seguros', 'veiculos', 'viagens'];
            if (premiumCategories.includes(category) && !isPremium) {
                alert('Esta categoria está disponível apenas no plano Premium!');
                showPremiumModal();
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('deadlines')
                    .insert([{
                        user_id: currentUser.id,
                        title,
                        description,
                        date,
                        category,
                        priority,
                        notification
                    }]);

                if (error) throw error;
                
                closeModal('newDeadlineModal');
                document.getElementById('deadlineForm').reset();
                await loadDeadlines();
                
                // Save to localStorage for offline
                saveToLocalStorage();
                
            } catch (error) {
                alert('Erro ao salvar prazo: ' + error.message);
            }
        });

        // Notifications
        function requestNotificationPermission() {
            if ('Notification' in window && 'serviceWorker' in navigator) {
                Notification.requestPermission();
            }
        }

        function scheduleNotifications() {
            deadlines.forEach(deadline => {
                if (deadline.notification && !deadline.completed) {
                    const deadlineDate = new Date(deadline.date);
                    const now = new Date();
                    
                    // Schedule notifications for 30 days, 1 week, and 24 hours before
                    const notifications = [
                        { days: 30, message: `Prazo em 30 dias: ${deadline.title}` },
                        { days: 7, message: `Prazo em 1 semana: ${deadline.title}` },
                        { days: 1, message: `Prazo em 24 horas: ${deadline.title}` }
                    ];
                    
                    notifications.forEach(notif => {
                        const notificationTime = new Date(deadlineDate.getTime() - (notif.days * 24 * 60 * 60 * 1000));
                        if (notificationTime > now) {
                            const timeUntilNotification = notificationTime.getTime() - now.getTime();
                            setTimeout(() => {
                                showNotification(notif.message);
                            }, timeUntilNotification);
                        }
                    });
                }
            });
        }

        function showNotification(message) {
            if (Notification.permission === 'granted') {
                new Notification('DeadlineX', {
                    body: message,
                    icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">⏰</text></svg>'
                });
            }
        }

        // Utility Functions
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR') + ' ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function getCategoryName(category) {
            const categories = {
                'pessoal': 'Pessoal',
                'trabalho': 'Trabalho',
                'saude': 'Saúde',
                'outros': 'Outros',
                'aniversarios': 'Aniversários',
                'educacao': 'Educação',
                'eventos': 'Eventos',
                'financeiro': 'Financeiro',
                'impostos': 'Impostos',
                'juridico': 'Jurídico',
'manutencao': 'Manutenção',
                'reunioes': 'Reuniões',
                'seguros': 'Seguros',
                'veiculos': 'Veículos',
                'viagens': 'Viagens'
            };
            return categories[category] || category;
        }

        function getPriorityName(priority) {
            const priorities = {
                'high': 'Alta',
                'normal': 'Normal',
                'low': 'Baixa'
            };
            return priorities[priority] || priority;
        }

        function updateStats() {
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            const total = deadlines.length;
            const urgent = deadlines.filter(d => !d.completed && new Date(d.date) <= new Date(now.getTime() + 24 * 60 * 60 * 1000)).length;
            const thisWeek = deadlines.filter(d => !d.completed && new Date(d.date) <= weekFromNow).length;
            const completed = deadlines.filter(d => d.completed).length;
            
            document.getElementById('totalCount').textContent = total;
            document.getElementById('urgentCount').textContent = urgent;
            document.getElementById('weekCount').textContent = thisWeek;
            document.getElementById('completedCount').textContent = completed;
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', renderDeadlines);
            document.getElementById('categoryFilter').addEventListener('change', function() {
                const selectedValue = this.value;
                const premiumCategories = ['aniversarios', 'educacao', 'eventos', 'financeiro', 'impostos', 'juridico', 'manutencao', 'reunioes', 'seguros', 'veiculos', 'viagens'];
                
                if (premiumCategories.includes(selectedValue) && !isPremium) {
                    alert('Esta categoria está disponível apenas no plano Premium!');
                    this.value = '';
                    showPremiumModal();
                    return;
                }
                renderDeadlines();
            });
        }

        function setupPremiumFeatures() {
            const premiumOptions = document.querySelectorAll('.premium-option');
            premiumOptions.forEach(option => {
                if (isPremium) {
                    option.classList.remove('text-gray-400');
                    option.textContent = option.textContent.replace('🔒 ', '').replace(' (Premium)', '');
                }
            });
        }

        // Modal Functions
        function showNewDeadlineModal() {
            document.getElementById('newDeadlineModal').classList.remove('hidden');
        }

        function showPremiumModal() {
            document.getElementById('premiumModal').classList.remove('hidden');
        }

        function showPolicies() {
            document.getElementById('policiesModal').classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        // Premium Functions
        async function purchasePremium() {
            try {
                // Create Mercado Pago preference
                const preference = {
                    items: [{
                        title: 'DeadlineX Premium - Assinatura Mensal',
                        description: 'Acesso completo a todas as funcionalidades premium',
                        quantity: 1,
                        currency_id: 'BRL',
                        unit_price: 4.90
                    }],
                    payer: {
                        email: currentUser.email,
                        name: currentUser.user_metadata.full_name
                    },
                    back_urls: {
                        success: window.location.origin + '/success',
                        failure: window.location.origin + '/failure',
                        pending: window.location.origin + '/pending'
                    },
                    auto_return: 'approved',
                    external_reference: currentUser.id,
                    notification_url: 'YOUR_WEBHOOK_URL'
                };

                // Call your backend to create the preference
                const response = await fetch('/api/create-preference', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(preference)
                });

                const data = await response.json();
                
                if (data.init_point) {
                    // Redirect to Mercado Pago
                    window.location.href = data.init_point;
                } else {
                    throw new Error('Erro ao criar preferência de pagamento');
                }
                
            } catch (error) {
                console.error('Erro no pagamento:', error);
                // Fallback - simulate premium for demo
                alert('Demo: Ativando Premium...\n\nEm produção, você seria redirecionado para o Mercado Pago.');
                isPremium = true;
                await updateUserSettings({ premium: true });
                setupPremiumFeatures();
                document.getElementById('shoppingSection').classList.remove('hidden');
                closeModal('premiumModal');
            }
        }

        // WhatsApp Notification Function
        async function sendWhatsAppNotification(message, phoneNumber) {
            if (!isPremium) return;
            
            try {
                const response = await fetch(`${WHATSAPP_API_URL}/message/sendText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${WHATSAPP_API_KEY}`
                    },
                    body: JSON.stringify({
                        number: phoneNumber,
                        text: message
                    })
                });

                const result = await response.json();
                console.log('WhatsApp notification sent:', result);
            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
            }
        }

        async function updateUserSettings(settings) {
            try {
                const { data, error } = await supabase
                    .from('user_settings')
                    .upsert([{
                        user_id: currentUser.id,
                        settings: settings
                    }]);
                
                if (error) throw error;
            } catch (error) {
                console.error('Error updating user settings:', error);
            }
        }

        // Other Functions
        function shareApp() {
            if (navigator.share) {
                navigator.share({
                    title: 'DeadlineX - Gerenciador de Prazos',
                    text: 'Gerencie seus prazos com inteligência!',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                alert('Link copiado para a área de transferência!');
            }
        }

        function installApp() {
            alert('Para instalar o app:\n\n1. No Chrome: Menu > Instalar DeadlineX\n2. No Safari: Compartilhar > Adicionar à Tela Inicial');
        }

        function showNotifications() {
            const urgentDeadlines = deadlines.filter(d => {
                const now = new Date();
                const deadlineDate = new Date(d.date);
                return !d.completed && deadlineDate <= new Date(now.getTime() + 24 * 60 * 60 * 1000);
            });
            
            if (urgentDeadlines.length === 0) {
                alert('Nenhuma notificação urgente no momento!');
            } else {
                const message = urgentDeadlines.map(d => `• ${d.title} - ${formatDate(d.date)}`).join('\n');
                alert(`Prazos urgentes:\n\n${message}`);
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            renderDeadlines();
        }

        async function toggleComplete(id) {
            const deadline = deadlines.find(d => d.id === id);
            if (!deadline) return;
            
            try {
                const { error } = await supabase
                    .from('deadlines')
                    .update({ completed: !deadline.completed })
                    .eq('id', id);
                
                if (error) throw error;
                await loadDeadlines();
            } catch (error) {
                alert('Erro ao atualizar prazo: ' + error.message);
            }
        }

        async function deleteDeadline(id) {
            if (!confirm('Tem certeza que deseja excluir este prazo?')) return;
            
            try {
                const { error } = await supabase
                    .from('deadlines')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                await loadDeadlines();
            } catch (error) {
                alert('Erro ao excluir prazo: ' + error.message);
            }
        }

        async function deleteAccount() {
            if (!confirm('ATENÇÃO: Esta ação irá excluir permanentemente sua conta e todos os seus dados. Esta ação não pode ser desfeita.\n\nTem certeza que deseja continuar?')) return;
            
            try {
                // Delete user data from all tables
                await supabase.from('deadlines').delete().eq('user_id', currentUser.id);
                await supabase.from('user_settings').delete().eq('user_id', currentUser.id);
                await supabase.from('user_config').delete().eq('user_id', currentUser.id);
                
                // Sign out user
                await supabase.auth.signOut();
                
                alert('Sua conta foi excluída com sucesso.');
                showLoginScreen();
            } catch (error) {
                alert('Erro ao excluir conta: ' + error.message);
            }
        }

        // Offline Support
        function saveToLocalStorage() {
            localStorage.setItem('deadlinex_data', JSON.stringify({
                deadlines: deadlines,
                user: currentUser,
                isPremium: isPremium,
                lastSync: new Date().toISOString()
            }));
        }

        function loadFromLocalStorage() {
            const data = localStorage.getItem('deadlinex_data');
            if (data) {
                const parsed = JSON.parse(data);
                deadlines = parsed.deadlines || [];
                isPremium = parsed.isPremium || false;
                renderDeadlines();
                updateStats();
            }
        }

        // Check for offline mode
        window.addEventListener('online', function() {
            console.log('Back online - syncing data...');
            loadUserData();
        });

        window.addEventListener('offline', function() {
            console.log('Offline mode - using local data...');
            loadFromLocalStorage();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97f8b42e979c4d35',t:'MTc1Nzk0NTM4Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

























