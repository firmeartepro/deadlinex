<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeadlineX - Sistema de Gest√£o de Prazos</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="DeadlineX">
    <meta name="description" content="Sistema profissional de gest√£o de prazos com notifica√ß√µes inteligentes">
    
    <!-- Favicon e Icons -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='35' font-family='Arial,sans-serif' font-size='24' font-weight='bold' text-anchor='middle' fill='white'%3E12:34%3C/text%3E%3Ctext x='50' y='55' font-family='Arial,sans-serif' font-size='12' text-anchor='middle' fill='white'%3EDEADLINE%3C/text%3E%3Ctext x='50' y='75' font-family='Arial,sans-serif' font-size='8' text-anchor='middle' fill='white'%3EMANAGER%3C/text%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='35' font-family='Arial,sans-serif' font-size='24' font-weight='bold' text-anchor='middle' fill='white'%3E12:34%3C/text%3E%3Ctext x='50' y='55' font-family='Arial,sans-serif' font-size='12' text-anchor='middle' fill='white'%3EDEADLINE%3C/text%3E%3Ctext x='50' y='75' font-family='Arial,sans-serif' font-size='8' text-anchor='middle' fill='white'%3EMANAGER%3C/text%3E%3C/svg%3E">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .btn-large { padding: 1rem 1.5rem; font-size: 1.1rem; min-height: 3.5rem; }
        .mobile-optimized { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        
        /* PWA Install Button Animation */
        .install-prompt {
            animation: slideInUp 0.5s ease-out;
        }
        @keyframes slideInUp {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Logo Animation */
        .logo-pulse {
            animation: logoPulse 3s ease-in-out infinite;
        }
        @keyframes logoPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen mobile-optimized">
    <!-- PWA Install Prompt -->
    <div id="installPrompt" class="fixed bottom-0 left-0 right-0 bg-gradient-to-r from-purple-600 to-blue-600 text-white p-4 z-50 hidden install-prompt">
        <div class="flex items-center justify-between max-w-md mx-auto">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-white rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                    </svg>
                </div>
                <div>
                    <p class="font-semibold text-sm">Instalar DeadlineX</p>
                    <p class="text-xs opacity-90">Adicione √† tela inicial</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="installBtn" class="bg-white text-purple-600 px-4 py-2 rounded-lg text-sm font-semibold hover:bg-gray-100 transition-colors">
                    Instalar
                </button>
                <button id="dismissInstall" class="text-white opacity-75 hover:opacity-100 p-2">
                    ‚úï
                </button>
            </div>
        </div>
    </div>

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen gradient-bg flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl p-8 max-w-md w-full card-shadow">
            <!-- Logo -->
            <div class="text-center mb-8">
                <div class="inline-block logo-pulse">
                    <svg width="80" height="80" viewBox="0 0 100 100" class="mx-auto mb-4">
                        <defs>
                            <linearGradient id="logoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect width="100" height="100" rx="20" fill="url(#logoGrad)"/>
                        <text x="50" y="35" font-family="Inter,sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="white">12:34</text>
                        <text x="50" y="55" font-family="Inter,sans-serif" font-size="12" text-anchor="middle" fill="white">DEADLINE</text>
                        <text x="50" y="75" font-family="Inter,sans-serif" font-size="8" text-anchor="middle" fill="white">MANAGER</text>
                    </svg>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">DeadlineX</h1>
                <p class="text-gray-600">Sistema Profissional de Gest√£o de Prazos</p>
            </div>
            
            <!-- Abas Login/Cadastro -->
            <div class="flex mb-6 bg-gray-100 rounded-lg p-1">
                <button id="loginTab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-purple-600 shadow-sm">
                    Entrar
                </button>
                <button id="registerTab" class="flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-800">
                    Cadastrar
                </button>
            </div>

            <!-- Formul√°rio de Login -->
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="userIdentifier" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" placeholder="Digite seu email" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <div class="relative">
                        <input type="password" id="userPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg pr-12" placeholder="Digite sua senha" required>
                        <button type="button" id="toggleLoginPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:from-purple-700 hover:to-blue-700 transition-all duration-200 transform hover:scale-105">
                    Entrar no Sistema
                </button>
            </form>

            <!-- Formul√°rio de Cadastro -->
            <form id="registerForm" class="space-y-6 hidden">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nome Completo</label>
                    <input type="text" id="registerName" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" placeholder="Digite seu nome completo" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                    <input type="email" id="registerEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" placeholder="Digite seu email" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Senha</label>
                    <div class="relative">
                        <input type="password" id="registerPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg pr-12" placeholder="Crie uma senha segura" required>
                        <button type="button" id="toggleRegisterPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            üëÅÔ∏è
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">M√≠nimo 6 caracteres</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Senha</label>
                    <div class="relative">
                        <input type="password" id="confirmPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg pr-12" placeholder="Digite a senha novamente" required>
                        <button type="button" id="toggleConfirmPassword" class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-500 hover:text-gray-700">
                            üëÅÔ∏è
                        </button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Telefone (opcional)</label>
                    <input type="tel" id="registerPhone" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-lg" placeholder="(11) 99999-9999">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-green-600 to-blue-600 text-white py-3 rounded-lg font-semibold text-lg hover:from-green-700 hover:to-blue-700 transition-all duration-200 transform hover:scale-105">
                    Criar Conta
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500">Seus dados ficam seguros e privados</p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg sticky top-0 z-40">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <svg width="40" height="40" viewBox="0 0 100 100" class="flex-shrink-0">
                            <defs>
                                <linearGradient id="headerGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                    <stop offset="0%" style="stop-color:#ffffff;stop-opacity:0.9" />
                                    <stop offset="100%" style="stop-color:#ffffff;stop-opacity:0.7" />
                                </linearGradient>
                            </defs>
                            <rect width="100" height="100" rx="20" fill="url(#headerGrad)"/>
                            <text x="50" y="35" font-family="Inter,sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="#667eea">12:34</text>
                            <text x="50" y="55" font-family="Inter,sans-serif" font-size="12" text-anchor="middle" fill="#667eea">DEADLINE</text>
                            <text x="50" y="75" font-family="Inter,sans-serif" font-size="8" text-anchor="middle" fill="#667eea">MANAGER</text>
                        </svg>
                        <div>
                            <h1 class="text-xl md:text-2xl font-bold">DeadlineX</h1>
                            <p class="text-xs opacity-75" id="userWelcome">Bem-vindo!</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <!-- Bot√£o compartilhar responsivo -->
                        <button id="shareBtn" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-4 py-2 rounded-lg transition-colors text-base items-center space-x-2 flex">
                            <span>üì§</span>
                            <span>Compartilhar</span>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <div class="container mx-auto px-4 py-6">
            <!-- Action Buttons -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <button id="newDeadlineBtn" class="bg-green-500 hover:bg-green-600 text-white btn-large rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 card-shadow flex flex-col items-center space-y-2">
                    <span class="text-2xl">‚ûï</span>
                    <span class="text-sm md:text-base">Novo Prazo</span>
                </button>
                <button id="notificationBtn" class="bg-purple-500 hover:bg-purple-600 text-white btn-large rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 card-shadow flex flex-col items-center space-y-2">
                    <span class="text-2xl">üîî</span>
                    <span class="text-sm md:text-base">Notifica√ß√µes</span>
                </button>
                <button id="installAppBtn" class="bg-blue-500 hover:bg-blue-600 text-white btn-large rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 card-shadow flex flex-col items-center space-y-2">
                    <span class="text-2xl">üì±</span>
                    <span class="text-sm md:text-base">Instalar App</span>
                </button>
                <button id="googleCalendarBtn" class="bg-red-500 hover:bg-red-600 text-white btn-large rounded-xl font-semibold transition-all duration-200 transform hover:scale-105 card-shadow flex flex-col items-center space-y-2">
                    <span class="text-2xl">üìÖ</span>
                    <span class="text-sm md:text-base">Google Agenda</span>
                </button>
            </div>

            <!-- Statistics Cards -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6 mb-8">
                <div class="bg-white p-4 md:p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs md:text-sm">Total</p>
                            <p id="totalCount" class="text-xl md:text-2xl font-bold text-gray-800">0</p>
                        </div>
                        <div class="bg-blue-100 p-2 md:p-3 rounded-full">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs md:text-sm">Urgentes</p>
                            <p id="urgentCount" class="text-xl md:text-2xl font-bold text-red-600 pulse-animation">0</p>
                        </div>
                        <div class="bg-red-100 p-2 md:p-3 rounded-full">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs md:text-sm">Esta Semana</p>
                            <p id="weekCount" class="text-xl md:text-2xl font-bold text-orange-600">0</p>
                        </div>
                        <div class="bg-orange-100 p-2 md:p-3 rounded-full">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5a2.25 2.25 0 002.25-2.25m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5a2.25 2.25 0 012.25 2.25v7.5"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 md:p-6 rounded-xl card-shadow">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-600 text-xs md:text-sm">Conclu√≠dos</p>
                            <p id="completedCount" class="text-xl md:text-2xl font-bold text-green-600">0</p>
                        </div>
                        <div class="bg-green-100 p-2 md:p-3 rounded-full">
                            <svg class="w-4 h-4 md:w-6 md:h-6 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Connection Status -->
            <div id="connectionStatus" class="mb-4 p-3 rounded-lg text-sm font-medium hidden">
            </div>

            <!-- Deadlines List -->
            <div class="bg-white rounded-xl card-shadow">
                <div class="p-4 md:p-6 border-b border-gray-200">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between space-y-4 md:space-y-0">
                        <h2 class="text-lg md:text-xl font-semibold text-gray-800">Meus Prazos</h2>
                        
                        <!-- Filtros de Busca -->
                        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3">
                            <div class="relative">
                                <input type="text" id="searchInput" placeholder="üîç Buscar por t√≠tulo..." class="pl-4 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm w-full sm:w-48">
                            </div>
                            <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-sm">
                                <option value="">üìã Todas as categorias</option>
                                <option value="trabalho">üè¢ Trabalho</option>
                                <option value="pessoal">üë§ Pessoal</option>
                                <option value="juridico">‚öñÔ∏è Jur√≠dico</option>
                                <option value="financeiro">üí∞ Financeiro</option>
                                <option value="saude">üè• Sa√∫de</option>
                                <option value="educacao">üìö Educa√ß√£o</option>
                                <option value="aniversarios">üéÇ Anivers√°rios</option>
                                <option value="contratos">üìÑ Contratos</option>
                                <option value="veiculo">üöó Ve√≠culo</option>
                                <option value="viagens">‚úàÔ∏è Viagens</option>
                                <option value="impostos">üßæ Impostos</option>
                                <option value="seguros">üõ°Ô∏è Seguros</option>
                                <option value="documentos">üìã Documentos</option>
                                <option value="eventos">üéâ Eventos</option>
                                <option value="manutencao">üîß Manuten√ß√£o</option>
                                <option value="reunioes">üë• Reuni√µes</option>
                                <option value="outros">üìã Outros</option>
                            </select>
                            <button id="clearFilters" class="px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-sm transition-colors">
                                ‚úñÔ∏è Limpar
                            </button>
                        </div>
                    </div>
                </div>
                <div id="deadlinesList" class="p-4 md:p-6">
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p>Carregando prazos...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hidden WhatsApp Section (for future use) -->
        <div id="whatsappSection" class="hidden">
            <button id="testWhatsappBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">
                üì± Testar WhatsApp
            </button>
            <button id="configBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">
                ‚öôÔ∏è Configurar WhatsApp
            </button>
        </div>
    </div>

    <!-- Modal: Novo/Editar Prazo -->
    <div id="deadlineModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6 max-h-screen overflow-y-auto">
                <h3 id="modalTitle" class="text-lg font-semibold mb-4">Novo Prazo</h3>
                <form id="deadlineForm">
                    <input type="hidden" id="editingId" value="">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">T√≠tulo</label>
                        <input type="text" id="deadlineTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Categoria</label>
                        <select id="deadlineCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="trabalho">üè¢ Trabalho</option>
                            <option value="pessoal">üë§ Pessoal</option>
                            <option value="juridico">‚öñÔ∏è Jur√≠dico</option>
                            <option value="financeiro">üí∞ Financeiro</option>
                            <option value="saude">üè• Sa√∫de</option>
                            <option value="educacao">üìö Educa√ß√£o</option>
                            <option value="aniversarios">üéÇ Anivers√°rios</option>
                            <option value="contratos">üìÑ Contratos</option>
                            <option value="veiculo">üöó Ve√≠culo</option>
                            <option value="viagens">‚úàÔ∏è Viagens</option>
                            <option value="impostos">üßæ Impostos</option>
                            <option value="seguros">üõ°Ô∏è Seguros</option>
                            <option value="documentos">üìã Documentos</option>
                            <option value="eventos">üéâ Eventos</option>
                            <option value="manutencao">üîß Manuten√ß√£o</option>
                            <option value="reunioes">üë• Reuni√µes</option>
                            <option value="outros">üìã Outros</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Data e Hora</label>
                        <input type="datetime-local" id="deadlineDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Descri√ß√£o</label>
                        <textarea id="deadlineDescription" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" rows="3"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelDeadline" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                        <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal: Google Calendar -->
    <div id="googleCalendarModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                        <span class="text-3xl">üìÖ</span>
                    </div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">Google Agenda</h3>
                    <p class="text-gray-600 text-sm">Sincronize seus prazos automaticamente</p>
                </div>
                
                <div id="googleCalendarContent">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
                
                <div class="flex justify-end space-x-3 mt-6">
                    <button id="cancelGoogleCalendar" class="px-4 py-2 text-gray-600 hover:text-gray-800">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Configurar WhatsApp (Hidden) -->
    <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl max-w-md w-full p-6">
                <h3 class="text-lg font-semibold mb-4">Configurar WhatsApp</h3>
                <form id="configForm">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Seu N√∫mero do WhatsApp</label>
                        <input type="tel" id="whatsappNumber" placeholder="5511999999999" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" required>
                        <p class="text-xs text-gray-500 mt-1">Formato: 5511999999999 (c√≥digo do pa√≠s + DDD + n√∫mero)</p>
                    </div>
                    <div class="mb-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="enableNotifications" class="mr-2">
                            <span class="text-sm text-gray-700">Ativar notifica√ß√µes autom√°ticas</span>
                        </label>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" id="cancelConfig" class="px-4 py-2 text-gray-600 hover:text-gray-800">Cancelar</button>
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // ===== SISTEMA DE VERSIONAMENTO =====
        const SYSTEM_VERSION = 'DeadlineX-v4.0-GoogleCalendarReal';
        console.log(`üöÄ ${SYSTEM_VERSION} - Integra√ß√£o Real com Google Calendar`);
        
        // ===== CRIA√á√ÉO DIN√ÇMICA DO MANIFEST PWA =====
        function createManifest() {
            const manifest = {
                "name": "DeadlineX",
                "short_name": "DeadlineX", 
                "description": "Sistema profissional de gest√£o de prazos com notifica√ß√µes inteligentes",
                "start_url": "/",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#667eea",
                "icons": [{
                    "src": "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cdefs%3E%3ClinearGradient id='grad' x1='0%25' y1='0%25' x2='100%25' y2='100%25'%3E%3Cstop offset='0%25' style='stop-color:%23667eea;stop-opacity:1' /%3E%3Cstop offset='100%25' style='stop-color:%23764ba2;stop-opacity:1' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width='100' height='100' rx='20' fill='url(%23grad)'/%3E%3Ctext x='50' y='35' font-family='Arial,sans-serif' font-size='24' font-weight='bold' text-anchor='middle' fill='white'%3E12:34%3C/text%3E%3Ctext x='50' y='55' font-family='Arial,sans-serif' font-size='12' text-anchor='middle' fill='white'%3EDEADLINE%3C/text%3E%3Ctext x='50' y='75' font-family='Arial,sans-serif' font-size='8' text-anchor='middle' fill='white'%3EMANAGER%3C/text%3E%3C/svg%3E",
                    "sizes": "512x512",
                    "type": "image/svg+xml"
                }]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = manifestURL;
            document.head.appendChild(link);
            
            console.log('‚úÖ Manifest PWA criado dinamicamente');
        }
        
        // Criar manifest imediatamente
        createManifest();
        
        // ===== SISTEMA DE DEBUG AVAN√áADO =====
        window.debugMode = true;
        
        function debugLog(message, data = null) {
            if (window.debugMode) {
                console.log(`üîç [DEBUG] ${message}`, data || '');
            }
        }
        
        function errorLog(message, error = null) {
            console.error(`‚ùå [ERRO] ${message}`, error || '');
            if (error) {
                console.error('Stack trace:', error.stack);
            }
        }

        // ===== CONFIGURA√á√ÉO SUPABASE =====
        const SUPABASE_URL = 'https://vastjlzaxafpoagptklu.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhc3RqbHpheGFmcG9hZ3B0a2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyNjUzMDEsImV4cCI6MjA3MTg0MTMwMX0.4EnnkdyVDEo1qSp1C2-QgVlklUkL2W3ulqOmXX_DiVY';
        
        let supabase;
        let currentUser = null;
        let deferredPrompt = null;
        
        // Aguardar carregamento completo do Supabase
        function initializeSupabase() {
            return new Promise((resolve) => {
                const checkSupabase = () => {
                    if (window.supabase && window.supabase.createClient) {
                        try {
                            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                            console.log('‚úÖ Supabase inicializado com sucesso');
                            console.log('üîó URL:', SUPABASE_URL);
                            console.log('üîë Key configurada:', SUPABASE_ANON_KEY ? 'Sim' : 'N√£o');
                            resolve(true);
                        } catch (error) {
                            console.error('‚ùå Erro ao inicializar Supabase:', error);
                            resolve(false);
                        }
                    } else {
                        console.log('‚è≥ Aguardando carregamento do Supabase...');
                        setTimeout(checkSupabase, 100);
                    }
                };
                checkSupabase();
            });
        }

        // ===== ESTADO DA APLICA√á√ÉO =====
        let deadlines = [];
        let filteredDeadlines = [];
        let userConfig = {
            whatsappNumber: '',
            enableNotifications: false,
            googleCalendarEnabled: false,
            googleAccessToken: null,
            googleRefreshToken: null,
            deadlineXCalendarId: null
        };

        // ===== ELEMENTOS DOM COM VERIFICA√á√ÉO SEGURA =====
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`‚ö†Ô∏è Elemento n√£o encontrado: ${id}`);
            }
            return element;
        }

        const elements = {
            loginScreen: safeGetElement('loginScreen'),
            mainApp: safeGetElement('mainApp'),
            loginForm: safeGetElement('loginForm'),
            registerForm: safeGetElement('registerForm'),
            loginTab: safeGetElement('loginTab'),
            registerTab: safeGetElement('registerTab'),
            userIdentifier: safeGetElement('userIdentifier'),
            userPassword: safeGetElement('userPassword'),
            userWelcome: safeGetElement('userWelcome'),
            
            newDeadlineBtn: safeGetElement('newDeadlineBtn'),
            installAppBtn: safeGetElement('installAppBtn'),
            notificationBtn: safeGetElement('notificationBtn'),
            shareBtn: safeGetElement('shareBtn'),
            googleCalendarBtn: safeGetElement('googleCalendarBtn'),
            
            deadlineModal: safeGetElement('deadlineModal'),
            deadlineForm: safeGetElement('deadlineForm'),
            modalTitle: safeGetElement('modalTitle'),
            editingId: safeGetElement('editingId'),
            
            deadlinesList: safeGetElement('deadlinesList'),
            totalCount: safeGetElement('totalCount'),
            urgentCount: safeGetElement('urgentCount'),
            weekCount: safeGetElement('weekCount'),
            completedCount: safeGetElement('completedCount'),
            connectionStatus: safeGetElement('connectionStatus'),
            
            searchInput: safeGetElement('searchInput'),
            categoryFilter: safeGetElement('categoryFilter'),
            clearFilters: safeGetElement('clearFilters'),
            
            installPrompt: safeGetElement('installPrompt'),
            installBtn: safeGetElement('installBtn'),
            dismissInstall: safeGetElement('dismissInstall')
        };

        // ===== PWA E INSTALA√á√ÉO =====
        
        // Detectar se pode ser instalado
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Mostrar prompt autom√°tico na primeira visita
            if (!localStorage.getItem('installPromptShown') && elements.installPrompt) {
                setTimeout(() => {
                    elements.installPrompt.classList.remove('hidden');
                    localStorage.setItem('installPromptShown', 'true');
                }, 3000);
            }
        });

        // Bot√£o instalar no prompt
        if (elements.installBtn) {
            elements.installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log(`PWA install: ${outcome}`);
                    deferredPrompt = null;
                }
                if (elements.installPrompt) {
                    elements.installPrompt.classList.add('hidden');
                }
            });
        }

        // Dispensar prompt
        if (elements.dismissInstall) {
            elements.dismissInstall.addEventListener('click', () => {
                if (elements.installPrompt) {
                    elements.installPrompt.classList.add('hidden');
                }
            });
        }

        // Bot√£o instalar no app
        if (elements.installAppBtn) {
            elements.installAppBtn.addEventListener('click', () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                } else {
                    // Instru√ß√µes manuais
                    alert('Para instalar:\n\nüì± Mobile: Toque no menu do navegador > "Adicionar √† tela inicial"\n\nüíª Desktop: Clique no √≠cone de instala√ß√£o na barra de endere√ßos');
                }
            });
        }

        // ===== NOTIFICA√á√ïES PUSH =====
        
        async function requestNotificationPermission() {
            if ('Notification' in window) {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    showConnectionStatus('Notifica√ß√µes ativadas com sucesso! üîî', 'success');
                    scheduleNotifications();
                } else {
                    showConnectionStatus('Permiss√£o de notifica√ß√£o negada', 'error');
                }
            } else {
                showConnectionStatus('Notifica√ß√µes n√£o suportadas neste navegador', 'error');
            }
        }

        function scheduleNotifications() {
            // Limpar notifica√ß√µes anteriores
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.ready.then(registration => {
                    registration.getNotifications().then(notifications => {
                        notifications.forEach(notification => notification.close());
                    });
                });
            }

            deadlines.forEach(deadline => {
                if (deadline.completed) return;

                const deadlineDate = new Date(deadline.date);
                const now = new Date();

                // Notifica√ß√£o 3 dias antes
                const threeDaysBefore = new Date(deadlineDate.getTime() - 3 * 24 * 60 * 60 * 1000);
                if (threeDaysBefore > now) {
                    scheduleNotification(deadline, threeDaysBefore, '3 dias');
                }

                // Notifica√ß√£o 1 dia antes
                const oneDayBefore = new Date(deadlineDate.getTime() - 24 * 60 * 60 * 1000);
                if (oneDayBefore > now) {
                    scheduleNotification(deadline, oneDayBefore, '1 dia');
                }

                // Notifica√ß√£o 2 horas antes
                const twoHoursBefore = new Date(deadlineDate.getTime() - 2 * 60 * 60 * 1000);
                if (twoHoursBefore > now) {
                    scheduleNotification(deadline, twoHoursBefore, '2 horas');
                }
            });
        }

        function scheduleNotification(deadline, notifyTime, timeText) {
            const delay = notifyTime.getTime() - new Date().getTime();
            
            if (delay > 0) {
                setTimeout(() => {
                    if ('serviceWorker' in navigator && 'Notification' in window) {
                        navigator.serviceWorker.ready.then(registration => {
                            registration.showNotification(`‚è∞ Prazo em ${timeText}!`, {
                                body: `${deadline.title}\nVence: ${formatDate(new Date(deadline.date))}`,
                                icon: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Cdefs%3E%3ClinearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"%3E%3Cstop offset="0%" style="stop-color:%23667eea;stop-opacity:1" /%3E%3Cstop offset="100%" style="stop-color:%23764ba2;stop-opacity:1" /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect width="100" height="100" rx="20" fill="url(%23grad)"/%3E%3Ctext x="50" y="35" font-family="Arial,sans-serif" font-size="24" font-weight="bold" text-anchor="middle" fill="white"%3E12:34%3C/text%3E%3Ctext x="50" y="55" font-family="Arial,sans-serif" font-size="12" text-anchor="middle" fill="white"%3EDEADLINE%3C/text%3E%3Ctext x="50" y="75" font-family="Arial,sans-serif" font-size="8" text-anchor="middle" fill="white"%3EMANAGER%3C/text%3E%3C/svg%3E',
                                badge: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"%3E%3Ccircle cx="50" cy="50" r="50" fill="%23667eea"/%3E%3Ctext x="50" y="60" font-family="Arial,sans-serif" font-size="40" font-weight="bold" text-anchor="middle" fill="white"%3E!%3C/text%3E%3C/svg%3E',
                                tag: `deadline-${deadline.id}`,
                                requireInteraction: true,
                                actions: [
                                    { action: 'view', title: 'Ver Prazo' },
                                    { action: 'dismiss', title: 'Dispensar' }
                                ]
                            });
                        });
                    }
                }, delay);
            }
        }

        if (elements.notificationBtn) {
            elements.notificationBtn.addEventListener('click', requestNotificationPermission);
        }

        // ===== SISTEMA GOOGLE CALENDAR REAL =====
        
        const GOOGLE_CLIENT_ID = '335209075366-ad0pstc045slgc98dtkut3sj1ao5m4ut.apps.googleusercontent.com';
        const DISCOVERY_DOC = 'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest';
        const SCOPES = 'https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

        let gapi, googleAuth;
        let isGoogleAPILoaded = false;

        async function loadGoogleAPI() {
            try {
                console.log('üîÑ Carregando Google API...');
                
                // Carregar Google API Script
                if (!window.gapi) {
                    await loadScript('https://apis.google.com/js/api.js');
                }
                
                // Aguardar carregamento completo
                await new Promise((resolve) => {
                    gapi.load('client:auth2', resolve);
                });

                // Inicializar cliente
                await gapi.client.init({
                    clientId: GOOGLE_CLIENT_ID,
                    discoveryDocs: [DISCOVERY_DOC],
                    scope: SCOPES
                });

                googleAuth = gapi.auth2.getAuthInstance();
                isGoogleAPILoaded = true;
                
                console.log('‚úÖ Google API carregada com sucesso');
                console.log('üîë Client ID:', GOOGLE_CLIENT_ID);
                console.log('üîê Scopes:', SCOPES);
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao carregar Google API:', error);
                showConnectionStatus('‚ùå Erro ao carregar Google API: ' + error.message, 'error');
                return false;
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        async function connectGoogleCalendar() {
            try {
                console.log('üöÄ INICIANDO CONEX√ÉO COM GOOGLE CALENDAR');
                showConnectionStatus('Carregando Google API...', 'info');
                
                // Carregar API se necess√°rio
                if (!isGoogleAPILoaded) {
                    const loaded = await loadGoogleAPI();
                    if (!loaded) {
                        throw new Error('Falha ao carregar Google API');
                    }
                }
                
                showConnectionStatus('Solicitando autoriza√ß√£o...', 'info');
                console.log('üîê Solicitando autoriza√ß√£o do usu√°rio...');
                
                // Solicitar autoriza√ß√£o
                const authResult = await googleAuth.signIn();
                
                if (!authResult) {
                    throw new Error('Autoriza√ß√£o cancelada pelo usu√°rio');
                }
                
                console.log('‚úÖ Usu√°rio autorizado:', authResult.getBasicProfile().getName());
                
                // Obter tokens
                const authResponse = authResult.getAuthResponse();
                userConfig.googleAccessToken = authResponse.access_token;
                userConfig.googleRefreshToken = authResponse.refresh_token || null;
                userConfig.googleCalendarEnabled = true;
                
                console.log('üîë Tokens obtidos:', {
                    access_token: userConfig.googleAccessToken ? 'Presente' : 'Ausente',
                    refresh_token: userConfig.googleRefreshToken ? 'Presente' : 'Ausente'
                });
                
                // Salvar configura√ß√£o no Supabase
                if (currentUser) {
                    await supabase
                        .from('user_configs')
                        .upsert({
                            user_id: currentUser.id,
                            google_calendar_enabled: true,
                            google_access_token: userConfig.googleAccessToken,
                            google_refresh_token: userConfig.googleRefreshToken
                        });
                    
                    console.log('üíæ Configura√ß√£o salva no Supabase');
                }
                
                showConnectionStatus('‚úÖ Google Calendar conectado com sucesso!', 'success');
                updateGoogleCalendarModal();
                
                // Criar agenda DeadlineX
                await ensureDeadlineXCalendar();
                
                // Sincronizar prazos existentes
                await syncAllDeadlinesToGoogleCalendar();
                
            } catch (error) {
                console.error('‚ùå Erro ao conectar Google Calendar:', error);
                
                let errorMessage = 'Erro ao conectar com Google Calendar';
                if (error.message.includes('popup_blocked')) {
                    errorMessage = 'Popup bloqueado. Permita popups para este site.';
                } else if (error.message.includes('access_denied')) {
                    errorMessage = 'Acesso negado pelo usu√°rio.';
                } else if (error.message.includes('network')) {
                    errorMessage = 'Erro de conex√£o. Verifique sua internet.';
                }
                
                showConnectionStatus('‚ùå ' + errorMessage, 'error');
            }
        }

        async function disconnectGoogleCalendar() {
            try {
                console.log('üîå Desconectando Google Calendar...');
                
                // Desconectar da API
                if (googleAuth && googleAuth.isSignedIn.get()) {
                    await googleAuth.signOut();
                }
                
                // Limpar configura√ß√µes
                userConfig.googleCalendarEnabled = false;
                userConfig.googleAccessToken = null;
                userConfig.googleRefreshToken = null;
                userConfig.deadlineXCalendarId = null;
                
                // Remover do Supabase
                if (currentUser) {
                    await supabase
                        .from('user_configs')
                        .upsert({
                            user_id: currentUser.id,
                            google_calendar_enabled: false,
                            google_access_token: null,
                            google_refresh_token: null,
                            deadlinex_calendar_id: null
                        });
                }
                
                showConnectionStatus('Google Calendar desconectado', 'info');
                updateGoogleCalendarModal();
                
            } catch (error) {
                console.error('‚ùå Erro ao desconectar:', error);
                showConnectionStatus('‚ùå Erro ao desconectar: ' + error.message, 'error');
            }
        }

        async function ensureDeadlineXCalendar() {
            try {
                console.log('üìÖ Verificando agenda DeadlineX...');
                
                // Verificar se j√° temos o ID da agenda
                if (userConfig.deadlineXCalendarId) {
                    console.log('‚úÖ Agenda DeadlineX j√° existe:', userConfig.deadlineXCalendarId);
                    return userConfig.deadlineXCalendarId;
                }
                
                // Criar nova agenda
                const calendar = {
                    summary: 'DeadlineX - Prazos Importantes',
                    description: 'Agenda criada automaticamente pelo DeadlineX para organizar seus prazos e compromissos importantes.',
                    timeZone: 'America/Sao_Paulo'
                };
                
                console.log('üÜï Criando nova agenda DeadlineX...');
                
                const response = await gapi.client.calendar.calendars.insert({
                    resource: calendar
                });
                
                userConfig.deadlineXCalendarId = response.result.id;
                
                console.log('‚úÖ Agenda DeadlineX criada:', userConfig.deadlineXCalendarId);
                
                // Salvar no Supabase
                if (currentUser) {
                    await supabase
                        .from('user_configs')
                        .upsert({
                            user_id: currentUser.id,
                            google_calendar_enabled: true,
                            google_access_token: userConfig.googleAccessToken,
                            google_refresh_token: userConfig.googleRefreshToken,
                            deadlinex_calendar_id: userConfig.deadlineXCalendarId
                        });
                }
                
                showConnectionStatus('üìÖ Agenda "DeadlineX" criada no Google Calendar!', 'success');
                
                return userConfig.deadlineXCalendarId;
                
            } catch (error) {
                console.error('‚ùå Erro ao criar agenda DeadlineX:', error);
                showConnectionStatus('‚ùå Erro ao criar agenda: ' + error.message, 'error');
                return 'primary'; // Usar agenda principal como fallback
            }
        }

        async function syncDeadlineToGoogleCalendar(deadline) {
            if (!userConfig.googleCalendarEnabled || !isGoogleAPILoaded) {
                console.log('‚ö†Ô∏è Google Calendar n√£o conectado');
                return false;
            }
            
            try {
                console.log('üìÖ Sincronizando prazo:', deadline.title);
                
                // Garantir que temos uma agenda
                const calendarId = userConfig.deadlineXCalendarId || 'primary';
                
                // Criar evento
                const event = {
                    summary: `‚è∞ ${deadline.title}`,
                    description: `${deadline.description || ''}\n\nüìã Categoria: ${getCategoryName(deadline.category)}\nüöÄ Criado pelo DeadlineX\n\n‚ö†Ô∏è IMPORTANTE: Este √© um prazo que precisa da sua aten√ß√£o!`,
                    start: {
                        dateTime: new Date(deadline.date).toISOString(),
                        timeZone: 'America/Sao_Paulo'
                    },
                    end: {
                        dateTime: new Date(new Date(deadline.date).getTime() + 60 * 60 * 1000).toISOString(),
                        timeZone: 'America/Sao_Paulo'
                    },
                    colorId: '11', // Vermelho para destacar
                    reminders: {
                        useDefault: false,
                        overrides: [
                            { method: 'popup', minutes: 60 },
                            { method: 'popup', minutes: 1440 }, // 1 dia antes
                            { method: 'popup', minutes: 4320 }  // 3 dias antes
                        ]
                    }
                };
                
                console.log('üì§ Enviando evento para Google Calendar...');
                
                const response = await gapi.client.calendar.events.insert({
                    calendarId: calendarId,
                    resource: event
                });
                
                console.log('‚úÖ Evento criado:', response.result.id);
                
                // Salvar ID do evento no Supabase
                await supabase
                    .from('deadlines')
                    .update({ 
                        google_event_id: response.result.id,
                        google_calendar_synced: true
                    })
                    .eq('id', deadline.id);
                
                showConnectionStatus(`üìÖ "${deadline.title}" adicionado ao Google Calendar!`, 'success');
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao sincronizar:', error);
                
                let errorMessage = 'Erro ao sincronizar com Google Calendar';
                if (error.status === 401) {
                    errorMessage = 'Token expirado. Reconecte o Google Calendar.';
                    userConfig.googleCalendarEnabled = false;
                    updateGoogleCalendarModal();
                } else if (error.status === 403) {
                    errorMessage = 'Sem permiss√£o para criar eventos.';
                }
                
                showConnectionStatus(`‚ùå ${errorMessage}`, 'error');
                return false;
            }
        }

        async function syncAllDeadlinesToGoogleCalendar() {
            if (!userConfig.googleCalendarEnabled) return;
            
            console.log('üîÑ Sincronizando todos os prazos...');
            
            let synced = 0;
            for (const deadline of deadlines) {
                if (!deadline.completed && !deadline.google_event_id) {
                    const success = await syncDeadlineToGoogleCalendar(deadline);
                    if (success) synced++;
                    
                    // Pequena pausa para n√£o sobrecarregar a API
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
            }
            
            if (synced > 0) {
                showConnectionStatus(`üìÖ ${synced} prazos sincronizados com Google Calendar!`, 'success');
            }
            
            console.log(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${synced} prazos`);
        }

        function getCategoryName(category) {
            const names = {
                trabalho: 'Trabalho',
                pessoal: 'Pessoal',
                juridico: 'Jur√≠dico',
                financeiro: 'Financeiro',
                saude: 'Sa√∫de',
                educacao: 'Educa√ß√£o',
                aniversarios: 'Anivers√°rios',
                contratos: 'Contratos',
                veiculo: 'Ve√≠culo',
                viagens: 'Viagens',
                impostos: 'Impostos',
                seguros: 'Seguros',
                documentos: 'Documentos',
                eventos: 'Eventos',
                manutencao: 'Manuten√ß√£o',
                reunioes: 'Reuni√µes',
                outros: 'Outros'
            };
            return names[category] || 'Outros';
        }

        function updateGoogleCalendarModal() {
            const content = safeGetElement('googleCalendarContent');
            if (!content) return;
            
            if (userConfig.googleCalendarEnabled) {
                content.innerHTML = `
                    <div class="text-center">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <span class="text-2xl">‚úÖ</span>
                        </div>
                        <h4 class="font-semibold text-green-800 mb-2">Conectado com Sucesso!</h4>
                        <p class="text-sm text-gray-600 mb-4">Seus prazos s√£o sincronizados automaticamente com o Google Calendar.</p>
                        
                        <div class="bg-green-50 p-4 rounded-lg mb-4">
                            <h5 class="font-medium text-green-800 mb-2">‚ú® Recursos Ativos:</h5>
                            <ul class="text-sm text-green-700 space-y-1">
                                <li>‚Ä¢ Agenda "DeadlineX" dedicada</li>
                                <li>‚Ä¢ Lembretes 1h, 1 dia e 3 dias antes</li>
                                <li>‚Ä¢ Sincroniza√ß√£o em tempo real</li>
                                <li>‚Ä¢ Notifica√ß√µes no celular</li>
                            </ul>
                        </div>
                        
                        <div class="flex flex-wrap gap-2 justify-center">
                            <button id="syncNowBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm">
                                üîÑ Sincronizar Agora
                            </button>
                            <button id="testGoogleBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                                üß™ Testar Evento
                            </button>
                            <button id="disconnectGoogleBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm">
                                üîå Desconectar
                            </button>
                        </div>
                    </div>
                `;
                
                const syncBtn = document.getElementById('syncNowBtn');
                const testBtn = document.getElementById('testGoogleBtn');
                const disconnectBtn = document.getElementById('disconnectGoogleBtn');
                
                if (syncBtn) {
                    syncBtn.addEventListener('click', syncAllDeadlinesToGoogleCalendar);
                }
                
                if (testBtn) {
                    testBtn.addEventListener('click', async () => {
                        const testDeadline = {
                            id: 'test-' + Date.now(),
                            title: 'Teste de Sincroniza√ß√£o DeadlineX',
                            description: 'Este √© um evento de teste para verificar a integra√ß√£o com Google Calendar',
                            category: 'outros',
                            date: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                            completed: false
                        };
                        
                        const success = await syncDeadlineToGoogleCalendar(testDeadline);
                        
                        if (success) {
                            alert('‚úÖ Teste conclu√≠do!\n\nEvento de teste criado no seu Google Calendar.\nVerifique a agenda "DeadlineX" no seu celular ou computador!');
                        } else {
                            alert('‚ùå Erro no teste. Verifique o console para mais detalhes.');
                        }
                    });
                }
                
                if (disconnectBtn) {
                    disconnectBtn.addEventListener('click', () => {
                        if (confirm('Deseja desconectar do Google Calendar?')) {
                            disconnectGoogleCalendar();
                        }
                    });
                }
                
            } else {
                content.innerHTML = `
                    <div class="text-center">
                        <div class="bg-gray-50 p-6 rounded-lg mb-4">
                            <h4 class="font-semibold text-gray-800 mb-3">üöÄ Sincroniza√ß√£o Autom√°tica</h4>
                            <ul class="text-sm text-gray-600 space-y-2 mb-4">
                                <li>‚úÖ Todos os prazos aparecem no Google Calendar</li>
                                <li>‚è∞ Lembretes autom√°ticos no celular</li>
                                <li>üîÑ Sincroniza√ß√£o em tempo real</li>
                                <li>üì± Acesso em todos os dispositivos</li>
                                <li>üìÖ Agenda "DeadlineX" dedicada</li>
                            </ul>
                        </div>
                        
                        <div class="bg-blue-50 p-4 rounded-lg mb-4">
                            <p class="text-xs text-blue-700 mb-3">
                                <strong>‚ú® Agora com integra√ß√£o REAL!</strong><br>
                                Conecte sua conta Google e seus prazos aparecer√£o automaticamente no Google Calendar.
                            </p>
                        </div>
                        
                        <button id="connectGoogleBtn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold">
                            üìÖ Conectar Google Calendar
                        </button>
                    </div>
                `;
                
                const connectBtn = document.getElementById('connectGoogleBtn');
                if (connectBtn) {
                    connectBtn.addEventListener('click', connectGoogleCalendar);
                }
            }
        }

        function openGoogleCalendarModal() {
            updateGoogleCalendarModal();
            const modal = safeGetElement('googleCalendarModal');
            if (modal) {
                modal.classList.remove('hidden');
            }
        }

        if (elements.googleCalendarBtn) {
            elements.googleCalendarBtn.addEventListener('click', openGoogleCalendarModal);
        }

        const cancelGoogleBtn = safeGetElement('cancelGoogleCalendar');
        if (cancelGoogleBtn) {
            cancelGoogleBtn.addEventListener('click', () => {
                const modal = safeGetElement('googleCalendarModal');
                if (modal) {
                    modal.classList.add('hidden');
                }
            });
        }

        // ===== SISTEMA DE COMPARTILHAMENTO =====
        
        async function shareApp() {
            const shareData = {
                title: 'DeadlineX - Sistema de Gest√£o de Prazos',
                text: 'Organize seus prazos de forma profissional com notifica√ß√µes inteligentes!',
                url: window.location.href
            };

            try {
                if (navigator.share) {
                    await navigator.share(shareData);
                } else {
                    // Fallback para navegadores sem Web Share API
                    const text = `${shareData.title}\n${shareData.text}\n${shareData.url}`;
                    await navigator.clipboard.writeText(text);
                    showConnectionStatus('Link copiado para a √°rea de transfer√™ncia! üìã', 'success');
                }
            } catch (error) {
                console.log('Erro ao compartilhar:', error);
            }
        }

        function showSharePrompt() {
            // Verificar se j√° mostrou o prompt recentemente
            const lastShown = localStorage.getItem('sharePromptLastShown');
            const now = Date.now();
            const oneDay = 24 * 60 * 60 * 1000; // 24 horas em ms
            
            if (lastShown && (now - parseInt(lastShown)) < oneDay) {
                return; // N√£o mostrar se j√° mostrou nas √∫ltimas 24h
            }
            
            // Mostrar prompt ap√≥s 10 segundos de uso
            setTimeout(() => {
                const shouldShow = confirm(
                    'üöÄ Gostando do DeadlineX?\n\n' +
                    'Que tal compartilhar com seus amigos e colegas?\n' +
                    'Ajude outros a organizarem melhor seus prazos!\n\n' +
                    'Clique OK para compartilhar agora üì§'
                );
                
                if (shouldShow) {
                    shareApp();
                }
                
                // Marcar como mostrado
                localStorage.setItem('sharePromptLastShown', now.toString());
            }, 10000); // 10 segundos ap√≥s login
        }

        if (elements.shareBtn) {
            elements.shareBtn.addEventListener('click', shareApp);
        }

        // ===== SISTEMA DE AUTENTICA√á√ÉO =====
        
        // Alternar entre abas Login/Cadastro
        if (elements.loginTab) {
            elements.loginTab.addEventListener('click', () => {
                elements.loginTab.className = "flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-purple-600 shadow-sm";
                elements.registerTab.className = "flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-800";
                if (elements.loginForm) elements.loginForm.classList.remove('hidden');
                if (elements.registerForm) elements.registerForm.classList.add('hidden');
            });
        }

        if (elements.registerTab) {
            elements.registerTab.addEventListener('click', () => {
                elements.registerTab.className = "flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors bg-white text-purple-600 shadow-sm";
                elements.loginTab.className = "flex-1 py-2 px-4 rounded-md text-sm font-medium transition-colors text-gray-600 hover:text-gray-800";
                if (elements.registerForm) elements.registerForm.classList.remove('hidden');
                if (elements.loginForm) elements.loginForm.classList.add('hidden');
            });
        }

        // Funcionalidade mostrar/ocultar senha - com verifica√ß√£o de elementos
        const toggleLoginPassword = safeGetElement('toggleLoginPassword');
        if (toggleLoginPassword) {
            toggleLoginPassword.addEventListener('click', function() {
                if (elements.userPassword) {
                    const type = elements.userPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                    elements.userPassword.setAttribute('type', type);
                    this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                }
            });
        }

        const toggleRegisterPassword = safeGetElement('toggleRegisterPassword');
        if (toggleRegisterPassword) {
            toggleRegisterPassword.addEventListener('click', function() {
                const passwordField = safeGetElement('registerPassword');
                if (passwordField) {
                    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordField.setAttribute('type', type);
                    this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                }
            });
        }

        const toggleConfirmPassword = safeGetElement('toggleConfirmPassword');
        if (toggleConfirmPassword) {
            toggleConfirmPassword.addEventListener('click', function() {
                const passwordField = safeGetElement('confirmPassword');
                if (passwordField) {
                    const type = passwordField.getAttribute('type') === 'password' ? 'text' : 'password';
                    passwordField.setAttribute('type', type);
                    this.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
                }
            });
        }

        // Login
        if (elements.loginForm) {
            elements.loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                if (!elements.userIdentifier || !elements.userPassword) {
                    showConnectionStatus('‚ùå Elementos de login n√£o encontrados', 'error');
                    return;
                }
                
                const email = elements.userIdentifier.value.trim();
                const password = elements.userPassword.value;
                
                debugLog('Tentativa de login:', { email });
                
                if (!email || !password) {
                    showConnectionStatus('‚ùå Preencha email e senha', 'error');
                    return;
                }
                
                if (!supabase) {
                    errorLog('Supabase n√£o inicializado');
                    showConnectionStatus('‚ùå Sistema n√£o inicializado. Recarregue a p√°gina.', 'error');
                    return;
                }
                
                try {
                    showConnectionStatus('Fazendo login...', 'info');
                    
                    const { data, error } = await supabase.auth.signInWithPassword({
                        email: email,
                        password: password
                    });
                    
                    if (error) {
                        errorLog('Erro no login:', error);
                        let errorMessage = 'Erro no login';
                        
                        if (error.message.includes('Invalid login credentials')) {
                            errorMessage = 'Email ou senha incorretos';
                        } else if (error.message.includes('Email not confirmed')) {
                            errorMessage = 'Confirme seu email antes de fazer login';
                        } else {
                            errorMessage = error.message;
                        }
                        
                        showConnectionStatus('‚ùå ' + errorMessage, 'error');
                        return;
                    }
                    
                    currentUser = data.user;
                    debugLog('Login bem-sucedido:', currentUser);
                    
                    const userName = currentUser.user_metadata?.name || currentUser.email;
                    if (elements.userWelcome) {
                        elements.userWelcome.textContent = `Bem-vindo de volta, ${userName}!`;
                    }
                    
                    if (elements.loginScreen) elements.loginScreen.classList.add('hidden');
                    if (elements.mainApp) elements.mainApp.classList.remove('hidden');
                    
                    showConnectionStatus('‚úÖ Login realizado com sucesso!', 'success');
                    await initializeApp();
                    
                    // Mostrar prompt de compartilhamento ap√≥s login
                    showSharePrompt();
                    
                } catch (error) {
                    errorLog('Erro cr√≠tico no login:', error);
                    showConnectionStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
                }
            });
        }

        // Cadastro
        if (elements.registerForm) {
            elements.registerForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const nameField = safeGetElement('registerName');
                const emailField = safeGetElement('registerEmail');
                const passwordField = safeGetElement('registerPassword');
                const confirmPasswordField = safeGetElement('confirmPassword');
                const phoneField = safeGetElement('registerPhone');
                
                if (!nameField || !emailField || !passwordField || !confirmPasswordField) {
                    showConnectionStatus('‚ùå Elementos de cadastro n√£o encontrados', 'error');
                    return;
                }
                
                const name = nameField.value.trim();
                const email = emailField.value.trim();
                const password = passwordField.value;
                const confirmPassword = confirmPasswordField.value;
                const phone = phoneField ? phoneField.value.trim() : '';
                
                // Valida√ß√µes
                if (!name || !email || !password) {
                    showConnectionStatus('‚ùå Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                if (password.length < 6) {
                    showConnectionStatus('‚ùå A senha deve ter pelo menos 6 caracteres', 'error');
                    return;
                }
                
                if (password !== confirmPassword) {
                    showConnectionStatus('‚ùå As senhas n√£o coincidem', 'error');
                    return;
                }
                
                if (!supabase) {
                    errorLog('Supabase n√£o inicializado');
                    showConnectionStatus('‚ùå Sistema n√£o inicializado. Recarregue a p√°gina.', 'error');
                    return;
                }
                
                try {
                    showConnectionStatus('Criando conta...', 'info');
                    
                    const { data, error } = await supabase.auth.signUp({
                        email: email,
                        password: password,
                        options: {
                            data: {
                                name: name,
                                phone: phone
                            }
                        }
                    });
                    
                    if (error) {
                        errorLog('Erro no cadastro:', error);
                        let errorMessage = 'Erro no cadastro';
                        
                        if (error.message.includes('User already registered')) {
                            errorMessage = 'Este email j√° est√° cadastrado';
                        } else if (error.message.includes('Password should be at least')) {
                            errorMessage = 'Senha muito fraca';
                        } else {
                            errorMessage = error.message;
                        }
                        
                        showConnectionStatus('‚ùå ' + errorMessage, 'error');
                        return;
                    }
                    
                    currentUser = data.user;
                    debugLog('Cadastro bem-sucedido:', currentUser);
                    
                    if (elements.userWelcome) {
                        elements.userWelcome.textContent = `Bem-vindo, ${name}!`;
                    }
                    
                    if (elements.loginScreen) elements.loginScreen.classList.add('hidden');
                    if (elements.mainApp) elements.mainApp.classList.remove('hidden');
                    
                    // Mostrar mensagem de boas-vindas
                    showConnectionStatus(`üéâ Conta criada com sucesso! Bem-vindo ao DeadlineX, ${name}!`, 'success');
                    
                    await initializeApp();
                    
                    // Mostrar prompt de compartilhamento para novos usu√°rios
                    showSharePrompt();
                    
                } catch (error) {
                    errorLog('Erro cr√≠tico no cadastro:', error);
                    showConnectionStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
                }
            });
        }

        // ===== SISTEMA DE BUSCA E FILTROS =====
        
        function applyFilters() {
            if (!elements.searchInput || !elements.categoryFilter) return;
            
            const searchTerm = elements.searchInput.value.toLowerCase().trim();
            const selectedCategory = elements.categoryFilter.value;
            
            filteredDeadlines = deadlines.filter(deadline => {
                const matchesSearch = !searchTerm || 
                    deadline.title.toLowerCase().includes(searchTerm) ||
                    (deadline.description && deadline.description.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !selectedCategory || deadline.category === selectedCategory;
                
                return matchesSearch && matchesCategory;
            });
            
            renderDeadlines();
            updateStatistics();
            
            // Mostrar feedback da busca
            if (searchTerm || selectedCategory) {
                const resultCount = filteredDeadlines.length;
                showConnectionStatus(`üîç ${resultCount} prazo(s) encontrado(s)`, 'info');
            }
        }

        function clearFilters() {
            if (elements.searchInput) elements.searchInput.value = '';
            if (elements.categoryFilter) elements.categoryFilter.value = '';
            filteredDeadlines = [...deadlines];
            renderDeadlines();
            updateStatistics();
            showConnectionStatus('Filtros limpos', 'success');
        }

        // Event listeners para busca
        if (elements.searchInput) {
            elements.searchInput.addEventListener('input', applyFilters);
        }
        if (elements.categoryFilter) {
            elements.categoryFilter.addEventListener('change', applyFilters);
        }
        if (elements.clearFilters) {
            elements.clearFilters.addEventListener('click', clearFilters);
        }

        // ===== FUN√á√ïES DE UI =====
        
        function openModal(modalId, editData = null) {
            const modal = safeGetElement(modalId);
            if (!modal) return;
            
            modal.classList.remove('hidden');
            
            if (modalId === 'deadlineModal') {
                const titleField = safeGetElement('deadlineTitle');
                const categoryField = safeGetElement('deadlineCategory');
                const dateField = safeGetElement('deadlineDate');
                const descriptionField = safeGetElement('deadlineDescription');
                
                if (editData) {
                    if (elements.modalTitle) elements.modalTitle.textContent = 'Editar Prazo';
                    if (elements.editingId) elements.editingId.value = editData.id;
                    if (titleField) titleField.value = editData.title;
                    if (categoryField) categoryField.value = editData.category;
                    if (dateField) dateField.value = new Date(editData.date).toISOString().slice(0, 16);
                    if (descriptionField) descriptionField.value = editData.description || '';
                } else {
                    if (elements.modalTitle) elements.modalTitle.textContent = 'Novo Prazo';
                    if (elements.editingId) elements.editingId.value = '';
                    if (elements.deadlineForm) elements.deadlineForm.reset();
                }
            }
        }

        function closeModal(modalId) {
            const modal = safeGetElement(modalId);
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        function showConnectionStatus(message, type) {
            if (!elements.connectionStatus) return;
            
            elements.connectionStatus.textContent = message;
            elements.connectionStatus.className = `mb-4 p-3 rounded-lg text-sm font-medium ${
                type === 'success' ? 'bg-green-100 text-green-800' :
                type === 'error' ? 'bg-red-100 text-red-800' :
                'bg-blue-100 text-blue-800'
            }`;
            elements.connectionStatus.classList.remove('hidden');
            
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    elements.connectionStatus.classList.add('hidden');
                }, 3000);
            }
        }

        // ===== EVENT LISTENERS =====
        
        if (elements.newDeadlineBtn) {
            elements.newDeadlineBtn.addEventListener('click', () => openModal('deadlineModal'));
        }

        const cancelDeadlineBtn = safeGetElement('cancelDeadline');
        if (cancelDeadlineBtn) {
            cancelDeadlineBtn.addEventListener('click', () => closeModal('deadlineModal'));
        }

        if (elements.deadlineForm) {
            elements.deadlineForm.addEventListener('submit', saveDeadline);
        }

        // ===== FUN√á√ïES DO BANCO DE DADOS =====
        
        async function initializeDatabase() {
            try {
                // Verificar se as tabelas existem e criar se necess√°rio
                const { error: deadlinesError } = await supabase
                    .from('deadlines')
                    .select('count', { count: 'exact', head: true });

                if (deadlinesError && deadlinesError.code === '42P01') {
                    console.log('Criando tabela deadlines...');
                    // Tabela n√£o existe, mas n√£o podemos criar via JavaScript
                    // Mostrar instru√ß√µes
                    showConnectionStatus('Configure o banco de dados primeiro', 'error');
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Erro ao inicializar banco:', error);
                return false;
            }
        }

        async function saveDeadline(e) {
            e.preventDefault();
            
            debugLog('=== INICIANDO SALVAMENTO DE PRAZO ===');
            
            const isEditing = elements.editingId && elements.editingId.value !== '';
            debugLog('Modo de edi√ß√£o:', isEditing);
            debugLog('Usu√°rio atual:', currentUser);
            
            // Validar dados antes de enviar
            const titleField = safeGetElement('deadlineTitle');
            const categoryField = safeGetElement('deadlineCategory');
            const dateField = safeGetElement('deadlineDate');
            const descriptionField = safeGetElement('deadlineDescription');
            
            if (!titleField || !categoryField || !dateField) {
                showConnectionStatus('‚ùå Elementos do formul√°rio n√£o encontrados', 'error');
                return;
            }
            
            const title = titleField.value.trim();
            const category = categoryField.value;
            const date = dateField.value;
            const description = descriptionField ? descriptionField.value.trim() : '';
            
            if (!title || !category || !date) {
                showConnectionStatus('‚ùå Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            try {
                showConnectionStatus('Salvando prazo...', 'info');
                
                let result;
                
                if (isEditing) {
                    debugLog('=== ATUALIZANDO PRAZO NO SUPABASE ===');
                    
                    const updateData = {
                        title: title,
                        category: category,
                        date: date,
                        description: description
                    };
                    
                    result = await supabase
                        .from('deadlines')
                        .update(updateData)
                        .eq('id', elements.editingId.value)
                        .eq('user_id', currentUser.id)
                        .select();
                        
                } else {
                    debugLog('=== CRIANDO NOVO PRAZO NO SUPABASE ===');
                    
                    const insertData = {
                        title: title,
                        category: category,
                        date: date,
                        description: description,
                        user_id: currentUser.id,
                        completed: false
                    };
                    
                    result = await supabase
                        .from('deadlines')
                        .insert([insertData])
                        .select();
                }
                
                debugLog('Resultado Supabase:', result);
                
                if (result.error) {
                    errorLog('‚ùå Erro no Supabase:', result.error);
                    showConnectionStatus('‚ùå Erro ao salvar: ' + result.error.message, 'error');
                    return;
                }
                
                debugLog('‚úÖ Prazo salvo com sucesso no Supabase');
                showConnectionStatus(`‚úÖ Prazo ${isEditing ? 'atualizado' : 'salvo'} com sucesso!`, 'success');
                
                closeModal('deadlineModal');
                await loadDeadlines();
                scheduleNotifications();
                
                // Sincronizar com Google Calendar se conectado
                if (userConfig.googleCalendarEnabled && result.data && result.data[0]) {
                    await syncDeadlineToGoogleCalendar(result.data[0]);
                }
                
            } catch (error) {
                errorLog('‚ùå ERRO CR√çTICO ao salvar prazo:', error);
                showConnectionStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
            }
        }

        async function loadUserConfig() {
            if (!currentUser) return;
            
            try {
                const { data, error } = await supabase
                    .from('user_configs')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();
                
                if (data && !error) {
                    userConfig.googleCalendarEnabled = data.google_calendar_enabled || false;
                    userConfig.googleAccessToken = data.google_access_token || null;
                    userConfig.googleRefreshToken = data.google_refresh_token || null;
                    userConfig.deadlineXCalendarId = data.deadlinex_calendar_id || null;
                    debugLog('Configura√ß√£o do usu√°rio carregada:', userConfig);
                }
            } catch (error) {
                debugLog('Nenhuma configura√ß√£o encontrada, usando padr√µes');
            }
        }

        async function loadDeadlines() {
            if (!currentUser) {
                errorLog('Tentativa de carregar prazos sem usu√°rio logado');
                return;
            }

            debugLog('=== CARREGANDO PRAZOS DO SUPABASE ===');
            debugLog('Usu√°rio atual:', currentUser);

            try {
                showConnectionStatus('Carregando prazos...', 'info');
                
                const { data, error } = await supabase
                    .from('deadlines')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('date', { ascending: true });

                debugLog('Resultado do Supabase:', { data, error });

                if (error) {
                    errorLog('‚ùå Erro ao carregar prazos:', error);
                    showConnectionStatus('‚ùå Erro ao carregar: ' + error.message, 'error');
                    deadlines = [];
                } else {
                    deadlines = data || [];
                    debugLog(`‚úÖ ${deadlines.length} prazos carregados do Supabase`);
                    
                    if (deadlines.length > 0) {
                        showConnectionStatus(`‚úÖ ${deadlines.length} prazos carregados!`, 'success');
                    } else {
                        showConnectionStatus('Nenhum prazo encontrado. Crie seu primeiro prazo!', 'info');
                    }
                }
                
                // Aplicar filtros atuais
                filteredDeadlines = [...deadlines];
                applyFilters();
                scheduleNotifications();
                
            } catch (error) {
                errorLog('‚ùå ERRO CR√çTICO ao carregar prazos:', error);
                showConnectionStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
                
                deadlines = [];
                filteredDeadlines = [];
                renderDeadlines();
                updateStatistics();
            }
        }

        function renderDeadlines() {
            if (!elements.deadlinesList) return;
            
            const container = elements.deadlinesList;
            const deadlinesToShow = filteredDeadlines.length > 0 ? filteredDeadlines : deadlines;
            
            if (deadlinesToShow.length === 0) {
                const isFiltered = (elements.searchInput && elements.searchInput.value) || 
                                 (elements.categoryFilter && elements.categoryFilter.value);
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <svg class="w-12 h-12 md:w-16 md:h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-base md:text-lg">${isFiltered ? 'Nenhum prazo encontrado com esses filtros.' : 'Nenhum prazo cadastrado ainda.'}</p>
                        <p class="text-sm text-gray-400">${isFiltered ? 'Tente ajustar os filtros de busca.' : 'Clique em "Novo Prazo" para come√ßar!'}</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = deadlinesToShow.map(deadline => {
                const date = new Date(deadline.date);
                const now = new Date();
                const isUrgent = date <= now && !deadline.completed;
                const isThisWeek = date <= new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000) && !deadline.completed;

                return `
                    <div class="border-l-4 ${
                        deadline.completed ? 'border-green-500 bg-green-50' :
                        isUrgent ? 'border-red-500 bg-red-50' : 
                        isThisWeek ? 'border-orange-500 bg-orange-50' : 
                        'border-gray-300 bg-gray-50'
                    } p-4 mb-4 rounded-r-xl">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-semibold text-gray-800 text-base md:text-lg ${deadline.completed ? 'line-through' : ''}">${deadline.title}</h4>
                                <p class="text-sm text-gray-600">${getCategoryIcon(deadline.category)} ${deadline.category}</p>
                                <p class="text-sm text-gray-500">${formatDate(date)}</p>
                                ${deadline.description ? `<p class="text-sm text-gray-600 mt-2">${deadline.description}</p>` : ''}
                                ${deadline.google_calendar_synced ? '<p class="text-xs text-green-600 mt-1">üìÖ Sincronizado com Google Calendar</p>' : ''}
                            </div>
                            <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2 ml-4">
                                <button onclick="editDeadline(${deadline.id})" class="text-blue-600 hover:text-blue-800 p-2 rounded-lg hover:bg-blue-100 transition-colors" title="Editar prazo">
                                    <span class="text-lg">‚úèÔ∏è</span>
                                </button>
                                <button onclick="toggleComplete(${deadline.id})" class="text-green-600 hover:text-green-800 p-2 rounded-lg hover:bg-green-100 transition-colors" title="${deadline.completed ? 'Marcar como pendente' : 'Marcar como conclu√≠do'}">
                                    <span class="text-lg">${deadline.completed ? '‚úÖ' : '‚≠ï'}</span>
                                </button>
                                <button onclick="deleteDeadline(${deadline.id})" class="text-red-600 hover:text-red-800 p-2 rounded-lg hover:bg-red-100 transition-colors" title="Excluir prazo">
                                    <span class="text-lg">üóëÔ∏è</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateStatistics() {
            const now = new Date();
            const weekFromNow = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);

            // Usar deadlines originais para estat√≠sticas, n√£o filtrados
            const total = deadlines.length;
            const urgent = deadlines.filter(d => !d.completed && new Date(d.date) <= now).length;
            const thisWeek = deadlines.filter(d => !d.completed && new Date(d.date) <= weekFromNow).length;
            const completed = deadlines.filter(d => d.completed).length;

            if (elements.totalCount) elements.totalCount.textContent = total;
            if (elements.urgentCount) elements.urgentCount.textContent = urgent;
            if (elements.weekCount) elements.weekCount.textContent = thisWeek;
            if (elements.completedCount) elements.completedCount.textContent = completed;
        }

        function getCategoryIcon(category) {
            const icons = {
                trabalho: 'üè¢',
                pessoal: 'üë§',
                juridico: '‚öñÔ∏è',
                financeiro: 'üí∞',
                saude: 'üè•',
                educacao: 'üìö',
                aniversarios: 'üéÇ',
                contratos: 'üìÑ',
                veiculo: 'üöó',
                viagens: '‚úàÔ∏è',
                impostos: 'üßæ',
                seguros: 'üõ°Ô∏è',
                documentos: 'üìã',
                eventos: 'üéâ',
                manutencao: 'üîß',
                reunioes: 'üë•',
                outros: 'üìã'
            };
            return icons[category] || 'üìã';
        }

        function formatDate(date) {
            return date.toLocaleDateString('pt-BR') + ' √†s ' + date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        // ===== FUN√á√ïES GLOBAIS PARA BOT√ïES =====
        
        window.editDeadline = function(id) {
            const deadline = deadlines.find(d => d.id === id);
            if (deadline) {
                openModal('deadlineModal', deadline);
            }
        };

        window.toggleComplete = async function(id) {
            const deadline = deadlines.find(d => d.id === id);
            if (!deadline) return;

            try {
                const { error } = await supabase
                    .from('deadlines')
                    .update({ completed: !deadline.completed })
                    .eq('id', id)
                    .eq('user_id', currentUser.id);

                if (error) {
                    errorLog('Erro ao atualizar prazo:', error);
                    showConnectionStatus('‚ùå Erro ao atualizar: ' + error.message, 'error');
                    return;
                }

                await loadDeadlines();
                showConnectionStatus('‚úÖ Prazo atualizado!', 'success');
            } catch (error) {
                errorLog('Erro ao atualizar prazo:', error);
                showConnectionStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
            }
        };

        window.deleteDeadline = async function(id) {
            if (!confirm('Tem certeza que deseja excluir este prazo?')) return;

            try {
                const { error } = await supabase
                    .from('deadlines')
                    .delete()
                    .eq('id', id)
                    .eq('user_id', currentUser.id);

                if (error) {
                    errorLog('Erro ao excluir prazo:', error);
                    showConnectionStatus('‚ùå Erro ao excluir: ' + error.message, 'error');
                    return;
                }

                await loadDeadlines();
                showConnectionStatus('‚úÖ Prazo exclu√≠do com sucesso!', 'success');
            } catch (error) {
                errorLog('Erro ao excluir prazo:', error);
                showConnectionStatus('‚ùå Erro de conex√£o: ' + error.message, 'error');
            }
        };

        // ===== SERVICE WORKER PARA PWA =====
        
        if ('serviceWorker' in navigator) {
            // Criar Service Worker inline como blob
            const swCode = `
                const CACHE_NAME = 'deadlinex-v4.0';
                const urlsToCache = ['/'];

                self.addEventListener('install', event => {
                    console.log('SW: Installing...');
                    event.waitUntil(
                        caches.open(CACHE_NAME)
                            .then(cache => {
                                console.log('SW: Cache opened');
                                return cache.addAll(urlsToCache);
                            })
                            .catch(err => console.log('SW: Cache error:', err))
                    );
                });

                self.addEventListener('fetch', event => {
                    // S√≥ cachear requests GET
                    if (event.request.method !== 'GET') return;
                    
                    event.respondWith(
                        caches.match(event.request)
                            .then(response => {
                                if (response) {
                                    return response;
                                }
                                return fetch(event.request);
                            })
                            .catch(err => {
                                console.log('SW: Fetch error:', err);
                                return new Response('Offline', { status: 503 });
                            })
                    );
                });

                self.addEventListener('notificationclick', event => {
                    console.log('SW: Notification clicked');
                    event.notification.close();
                    
                    if (event.action === 'view') {
                        event.waitUntil(
                            clients.openWindow(self.location.origin)
                        );
                    }
                });

                self.addEventListener('activate', event => {
                    console.log('SW: Activating...');
                    event.waitUntil(
                        caches.keys().then(cacheNames => {
                            return Promise.all(
                                cacheNames.map(cacheName => {
                                    if (cacheName !== CACHE_NAME) {
                                        console.log('SW: Deleting old cache:', cacheName);
                                        return caches.delete(cacheName);
                                    }
                                })
                            );
                        })
                    );
                });
            `;
            
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            
            navigator.serviceWorker.register(swUrl)
                .then(registration => {
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                    
                    // Limpar URL do blob ap√≥s registro
                    URL.revokeObjectURL(swUrl);
                })
                .catch(error => {
                    console.log('‚ùå Erro ao registrar Service Worker:', error);
                    URL.revokeObjectURL(swUrl);
                });
        }

        // ===== INICIALIZA√á√ÉO =====
        
        async function initializeApp() {
            console.log(`üöÄ Inicializando ${SYSTEM_VERSION}...`);
            
            const dbReady = await initializeDatabase();
            if (dbReady) {
                await loadUserConfig();
                await loadDeadlines();
            }
            
            // Solicitar permiss√£o de notifica√ß√£o automaticamente
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(() => {
                    requestNotificationPermission();
                }, 2000);
            }
        }

        // Verificar se usu√°rio j√° est√° logado
        document.addEventListener('DOMContentLoaded', async () => {
            debugLog('=== INICIALIZANDO APLICA√á√ÉO ===');
            
            try {
                // Primeiro inicializar o Supabase
                const supabaseReady = await initializeSupabase();
                
                if (!supabaseReady) {
                    errorLog('Falha ao inicializar Supabase');
                    showConnectionStatus('‚ùå Erro de conex√£o com o banco de dados', 'error');
                    return;
                }
                
                // Verificar sess√£o existente
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    errorLog('Erro ao verificar sess√£o:', error);
                    showConnectionStatus('‚ùå Erro ao verificar login: ' + error.message, 'error');
                    return;
                }
                
                if (session?.user) {
                    currentUser = session.user;
                    debugLog('Usu√°rio logado encontrado:', currentUser);
                    
                    const userName = currentUser.user_metadata?.name || currentUser.email;
                    if (elements.userWelcome) {
                        elements.userWelcome.textContent = `Ol√°, ${userName}!`;
                    }
                    if (elements.loginScreen) elements.loginScreen.classList.add('hidden');
                    if (elements.mainApp) elements.mainApp.classList.remove('hidden');
                    
                    await initializeApp();
                    
                    // Mostrar prompt de compartilhamento para usu√°rios retornando
                    showSharePrompt();
                } else {
                    debugLog('Nenhum usu√°rio logado encontrado');
                    showConnectionStatus('Sistema pronto para login', 'info');
                }
            } catch (error) {
                errorLog('Erro cr√≠tico na inicializa√ß√£o:', error);
                showConnectionStatus('‚ùå Erro cr√≠tico: ' + error.message, 'error');
            }
        });

        // ===== FUN√á√ïES DE DIAGN√ìSTICO (PARA DESENVOLVIMENTO) =====
        
        window.diagnoseSystem = function() {
            console.log('üîç DIAGN√ìSTICO COMPLETO DO SISTEMA');
            console.log('==================================');
            console.log('Vers√£o:', SYSTEM_VERSION);
            console.log('Usu√°rio atual:', currentUser);
            console.log('Prazos carregados:', deadlines.length);
            console.log('Prazos filtrados:', filteredDeadlines.length);
            console.log('Supabase conectado:', !!supabase);
            console.log('Supabase URL:', SUPABASE_URL);
            console.log('Supabase Key presente:', !!SUPABASE_ANON_KEY);
            console.log('Google API carregada:', isGoogleAPILoaded);
            console.log('Google Calendar conectado:', userConfig.googleCalendarEnabled);
            console.log('Google Client ID:', GOOGLE_CLIENT_ID);
            console.log('Notifica√ß√µes:', Notification.permission);
            console.log('Service Worker:', 'serviceWorker' in navigator);
            console.log('PWA instal√°vel:', !!deferredPrompt);
            
            // Verificar elementos DOM
            console.log('=== ELEMENTOS DOM ===');
            Object.keys(elements).forEach(key => {
                console.log(`${key}:`, !!elements[key]);
            });
            
            // Testar conex√£o com Supabase
            if (supabase) {
                console.log('üß™ TESTANDO CONEX√ÉO COM SUPABASE...');
                
                // Teste b√°sico de conex√£o
                supabase.from('deadlines').select('count', { count: 'exact', head: true })
                    .then(result => {
                        console.log('‚úÖ Teste de conex√£o Supabase:', result);
                    })
                    .catch(error => {
                        console.log('‚ùå Erro no teste de conex√£o Supabase:', error);
                    });
                
                // Teste de autentica√ß√£o
                supabase.auth.getSession()
                    .then(result => {
                        console.log('üîê Status da sess√£o:', result);
                    })
                    .catch(error => {
                        console.log('‚ùå Erro ao verificar sess√£o:', error);
                    });
            } else {
                console.log('‚ùå Supabase n√£o inicializado!');
            }
            
            // Testar Google API
            if (isGoogleAPILoaded) {
                console.log('üß™ TESTANDO GOOGLE API...');
                console.log('Google Auth:', !!googleAuth);
                console.log('Usu√°rio logado no Google:', googleAuth ? googleAuth.isSignedIn.get() : 'N/A');
            } else {
                console.log('‚ùå Google API n√£o carregada!');
            }
        };
        
        // Disponibilizar globalmente
        window.deadlineXSystem = {
            version: SYSTEM_VERSION,
            diagnose: window.diagnoseSystem,
            currentUser: () => currentUser,
            deadlines: () => deadlines,
            filteredDeadlines: () => filteredDeadlines,
            userConfig: () => userConfig,
            connectGoogle: connectGoogleCalendar,
            disconnectGoogle: disconnectGoogleCalendar
        };
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97822c85b1619615',t:'MTc1NjcwMjUxMS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

















